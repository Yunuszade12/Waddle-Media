import{d as defineBlocksWithJsonArray,j as javascriptGenerator,O as Order,s as spriteManager,E as Extensions,a as Events,S as Sprite,v as variableManager,p as projectManager,b as EventEmitter,i as inject,c as serialization,W as Workspace,A as AmbientLight,D as DirectionalLight,e as WebGLRenderer,f as Scene,P as PerspectiveCamera,R as Raycaster,V as Vector2,g as Vector3}from"./index-wINcKeif.js";const defineBlocks=()=>{defineBlocksWithJsonArray([{type:"event_when_flag_clicked",message0:"when green flag clicked",nextStatement:null,colour:"#FFAB19"},{type:"event_stop_all",message0:"Finish game",previousStatement:null,colour:"#ff0000"},{type:"event_when_key",message0:"when %1 key pressed",args0:[{type:"field_dropdown",name:"KEY",options:[["space"," "],["enter","Enter"],["up arrow","ArrowUp"],["down arrow","ArrowDown"],["left arrow","ArrowLeft"],["right arrow","ArrowRight"],["shift","Shift"],["control","Control"],["alt","Alt"],["a","a"],["b","b"],["c","c"],["d","d"],["e","e"],["f","f"],["g","g"],["h","h"],["i","i"],["j","j"],["k","k"],["l","l"],["m","m"],["n","n"],["o","o"],["p","p"],["q","q"],["r","r"],["s","s"],["t","t"],["u","u"],["v","v"],["w","w"],["x","x"],["y","y"],["z","z"],["0","0"],["1","1"],["2","2"],["3","3"],["4","4"],["5","5"],["6","6"],["7","7"],["8","8"],["9","9"]]}],nextStatement:null,colour:"#FFAB19"},{type:"event_when_sprite_clicked",message0:"when this sprite clicked",nextStatement:null,colour:"#FFAB19"},{type:"event_when_clone_started",message0:"when I start as a clone",message1:"%1",args1:[{type:"input_statement",name:"STACK"}],colour:"#FFAB19"},{type:"broadcast",message0:"broadcast %1",args0:[{type:"field_input",name:"NAME",text:"message1"}],previousStatement:null,nextStatement:null,colour:"#FFAB19"},{type:"event_when_received",message0:"when I receive %1",args0:[{type:"field_input",name:"NAME",text:"message1"}],message1:"%1",args1:[{type:"input_statement",name:"STACK"}],colour:"#FFAB19"},{type:"move_sprite",message0:"move %1 steps",args0:[{type:"input_value",name:"STEPS"}],previousStatement:null,nextStatement:null,colour:"#4C97FF"},{type:"turn",message0:"turn %1 degrees",args0:[{type:"input_value",name:"DEGREE"}],previousStatement:null,nextStatement:null,colour:"#4C97FF"},{type:"go_to",message0:"go to x: %1 y: %2",args0:[{type:"input_value",name:"X"},{type:"input_value",name:"Y"}],previousStatement:null,nextStatement:null,colour:"#4C97FF"},{type:"glide",message0:"glide %1 secs to x: %2 y: %3",args0:[{type:"input_value",name:"SECS"},{type:"input_value",name:"X"},{type:"input_value",name:"Y"}],previousStatement:null,nextStatement:null,colour:"#4C97FF"},{type:"point_in_direction",message0:"point in direction %1",args0:[{type:"field_angle",name:"DIR",angle:90}],previousStatement:null,nextStatement:null,colour:"#4C97FF"},{type:"rotate_towards",message0:"rotate towards x: %1 y: %2",args0:[{type:"input_value",name:"X"},{type:"input_value",name:"Y"}],previousStatement:null,nextStatement:null,colour:"#4C97FF"},{type:"if_on_edge_bounce",message0:"if on edge, bounce",previousStatement:null,nextStatement:null,colour:"#4C97FF"},{type:"say",message0:"say %1 for %2 secs",args0:[{type:"input_value",name:"TEXT"},{type:"input_value",name:"SECS"}],previousStatement:null,nextStatement:null,colour:"#9966FF"},{type:"think",message0:"think %1 for %2 secs",args0:[{type:"input_value",name:"TEXT"},{type:"input_value",name:"SECS"}],previousStatement:null,nextStatement:null,colour:"#9966FF"},{type:"look_next_costume",message0:"next costume",previousStatement:null,nextStatement:null,colour:"#9966FF"},{type:"look_switch_costume",message0:"switch to costume %1",args0:[{type:"field_dropdown",name:"COSTUME",options:[["default","default"]]}],extensions:["dynamic_costume_extension"],previousStatement:null,nextStatement:null,colour:"#9966FF"},{type:"switch_backdrop",message0:"switch backdrop to %1",args0:[{type:"field_input",name:"BACKDROP",text:"backdrop1"}],previousStatement:null,nextStatement:null,colour:"#9966FF"},{type:"change_size_by",message0:"change size by %1",args0:[{type:"input_value",name:"DELTA"}],previousStatement:null,nextStatement:null,colour:"#9966FF"},{type:"set_size_to",message0:"set size to %1",args0:[{type:"input_value",name:"SIZE"}],previousStatement:null,nextStatement:null,colour:"#9966FF"},{type:"go_to_front_layer",message0:"go to front layer",previousStatement:null,nextStatement:null,colour:"#9966FF"},{type:"go_to_back_layer",message0:"go to back layer",previousStatement:null,nextStatement:null,colour:"#9966FF"},{type:"set_layer_to",message0:"go to layer %1",args0:[{type:"input_value",name:"LAYER"}],previousStatement:null,nextStatement:null,colour:"#9966FF"},{type:"show",message0:"show",previousStatement:null,nextStatement:null,colour:"#9966FF"},{type:"hide",message0:"hide",previousStatement:null,nextStatement:null,colour:"#9966FF"},{type:"set_flip_x",message0:"set flip horizontal %1",args0:[{type:"field_dropdown",name:"FLIP",options:[["on","true"],["off","false"]]}],previousStatement:null,nextStatement:null,colour:"#9966FF"},{type:"set_flip_y",message0:"set flip vertical %1",args0:[{type:"field_dropdown",name:"FLIP",options:[["on","true"],["off","false"]]}],previousStatement:null,nextStatement:null,colour:"#9966FF"},{type:"change_effect_by",message0:"change %1 effect by %2",args0:[{type:"field_dropdown",name:"EFFECT",options:[["color","color"],["fisheye","fisheye"],["pixelate","pixelate"],["ghost","ghost"]]},{type:"field_number",name:"AMOUNT",value:10}],previousStatement:null,nextStatement:null,colour:"#9966FF"},{type:"play_sound",message0:"play sound %1",args0:[{type:"field_dropdown",name:"SOUND_NAME",options:[["Select a sound","NONE"]]}],extensions:["dynamic_sound_menu"],previousStatement:null,nextStatement:null,colour:"#CF63CF"},{type:"start_sound",message0:"start sound %1",args0:[{type:"field_dropdown",name:"SOUND_NAME",options:[["Select a sound","NONE"]]}],extensions:["dynamic_sound_menu"],previousStatement:null,nextStatement:null,colour:"#CF63CF"},{type:"play_sound_until_done",message0:"play sound %1 until done",args0:[{type:"field_dropdown",name:"SOUND_NAME",options:[["Select a sound","NONE"]]}],extensions:["dynamic_sound_menu"],previousStatement:null,nextStatement:null,colour:"#CF63CF"},{type:"stop_all_sounds",message0:"stop all sounds",previousStatement:null,nextStatement:null,colour:"#CF63CF"},{type:"set_volume",message0:"set volume to %1%",args0:[{type:"input_value",name:"VOLUME"}],previousStatement:null,nextStatement:null,colour:"#CF63CF"},{type:"wait_block",message0:"wait %1 seconds",args0:[{type:"input_value",name:"SECONDS"}],previousStatement:null,nextStatement:null,colour:120},{type:"controls_if",message0:"if %1 then",args0:[{type:"input_value",name:"CONDITION",check:"Boolean"}],message1:"do %1",args1:[{type:"input_statement",name:"DO"}],previousStatement:null,nextStatement:null,colour:120},{type:"controls_if_else",message0:"if %1 then",args0:[{type:"input_value",name:"CONDITION",check:"Boolean"}],message1:"do %1",args1:[{type:"input_statement",name:"DO"}],message2:"else %1",args2:[{type:"input_statement",name:"ELSE"}],previousStatement:null,nextStatement:null,colour:120},{type:"controls_repeat",message0:"repeat %1 times",args0:[{type:"input_value",name:"TIMES"}],message1:"do %1",args1:[{type:"input_statement",name:"DO"}],previousStatement:null,nextStatement:null,colour:120},{type:"controls_forever",message0:"forever",message1:"do %1",args1:[{type:"input_statement",name:"DO"}],previousStatement:null,colour:120},{type:"wait_until",message0:"wait until %1",args0:[{type:"input_value",name:"COND",check:"Boolean"}],previousStatement:null,nextStatement:null,colour:120},{type:"create_clone",message0:"create clone of %1",args0:[{type:"field_dropdown",name:"CLONEOF",options:[["myself","myself"]]}],previousStatement:null,nextStatement:null,colour:120},{type:"delete_this_clone",message0:"delete this clone",previousStatement:null,nextStatement:null,colour:120},{type:"touching",message0:"touching %1 ?",args0:[{type:"field_dropdown",name:"TOUCHING",options:[["mouse-pointer","mouse"],["edge","edge"]]}],output:"Boolean",colour:"#5CB1D6"},{type:"isthisclone",message0:"is this a clone?",output:"Boolean",colour:"#5CB1D6"},{type:"sensing_touching_color",message0:"touching color %1 ?",args0:[{type:"field_colour",name:"COLOR",colour:"#ff0000"}],output:"Boolean",colour:"#5CB1D6"},{type:"touching_sprite",message0:"touching %1 ?",args0:[{type:"field_dropdown",name:"SPRITE",options:[["Select a sprite","NONE"]]}],extensions:["dynamic_sprite_menu"],output:"Boolean",colour:"#5CB1D6"},{type:"touching_edge",message0:"touching edge?",output:"Boolean",colour:"#5CB1D6"},{type:"touching_mouse",message0:"touching mouse?",output:"Boolean",colour:"#5CB1D6"},{type:"mouse_button_pressed",message0:"mouse %1 pressed?",args0:[{type:"field_dropdown",name:"BUTTON",options:[["left","left"],["right","right"]]}],output:"Boolean",colour:"#5CB1D6"},{type:"ask_and_wait",message0:"ask %1 and wait",args0:[{type:"input_value",name:"QUESTION"}],previousStatement:null,nextStatement:null,colour:"#5CB1D6"},{type:"key_pressed",message0:"key %1 pressed?",args0:[{type:"field_dropdown",name:"KEY",options:[["space"," "],["enter","Enter"],["up arrow","ArrowUp"],["down arrow","ArrowDown"],["left arrow","ArrowLeft"],["right arrow","ArrowRight"],["shift","Shift"],["control","Control"],["alt","Alt"],["a","a"],["b","b"],["c","c"],["d","d"],["e","e"],["f","f"],["g","g"],["h","h"],["i","i"],["j","j"],["k","k"],["l","l"],["m","m"],["n","n"],["o","o"],["p","p"],["q","q"],["r","r"],["s","s"],["t","t"],["u","u"],["v","v"],["w","w"],["x","x"],["y","y"],["z","z"],["0","0"],["1","1"],["2","2"],["3","3"],["4","4"],["5","5"],["6","6"],["7","7"],["8","8"],["9","9"]]}],output:"Boolean",colour:"#5CB1D6"},{type:"joystick_input",message0:"joystick %1",args0:[{type:"field_dropdown",name:"INPUT",options:[["A button","a"],["B button","b"],["X button","x"],["Y button","y"],["left bumper","lb"],["right bumper","rb"],["left trigger","lt"]]}],output:"Boolean",colour:"#5CB1D6"},{type:"distance_to",message0:"distance to %1",args0:[{type:"field_dropdown",name:"SPRITE",options:[["Select a sprite","NONE"]]}],extensions:["dynamic_sprite_menu"],output:"Number",colour:"#5CB1D6"},{type:"get_x",message0:"x position",output:"Number",colour:"#5CB1D6"},{type:"get_y",message0:"y position",output:"Number",colour:"#5CB1D6"},{type:"get_direction",message0:"direction",output:"Number",colour:"#5CB1D6"},{type:"get_size",message0:"size",output:"Number",colour:"#5CB1D6"},{type:"isthisclone",message0:"is this a clone?",output:"Boolean",colour:"#5CB1D6"},{type:"mouse_x",message0:"mouse x",output:"Number",colour:"#5CB1D6"},{type:"mouse_y",message0:"mouse y",output:"Number",colour:"#5CB1D6"},{type:"math_random",message0:"pick random %1 to %2",args0:[{type:"input_value",name:"FROM"},{type:"input_value",name:"TO"}],output:"Number",colour:"#59C059"},{type:"text_join",message0:"join %1 and %2",args0:[{type:"input_value",name:"A"},{type:"input_value",name:"B"}],output:"String",colour:"#59C059"},{type:"add",message0:"+ %1 %2",args0:[{type:"input_value",name:"NUMBER1"},{type:"input_value",name:"NUMBER2"}],output:"Number",colour:"#59C059"},{type:"subtract",message0:"- %1 %2",args0:[{type:"input_value",name:"NUMBER1"},{type:"input_value",name:"NUMBER2"}],output:"Number",colour:"#59C059"},{type:"divide",message0:"/ %1 %2",args0:[{type:"input_value",name:"NUMBER1"},{type:"input_value",name:"NUMBER2"}],output:"Number",colour:"#59C059"},{type:"multiply",message0:"* %1 %2",args0:[{type:"input_value",name:"NUMBER1"},{type:"input_value",name:"NUMBER2"}],output:"Number",colour:"#59C059"},{type:"compare",message0:"%1 %2 %3",args0:[{type:"input_value",name:"NUMBER1"},{type:"field_dropdown",name:"COMPARETYPE",options:[[">","GRATER"],["<","LESS"],["=","EQUAL"],["≤","LESS_EQUAL"],["≥","GREATER_EQUAL"]]},{type:"input_value",name:"NUMBER2"}],output:"Boolean",colour:"#59C059"},{type:"not",message0:"not %1",args0:[{type:"input_value",name:"BOOLEAN",check:"Boolean"}],output:"Boolean",colour:"#59C059"},{type:"logic",message0:"%1 %2 %3",args0:[{type:"input_value",name:"BOOLEAN1",check:"Boolean"},{type:"field_dropdown",name:"LOGICTYPE",options:[["and","AND"],["or","OR"],["xor","XOR"]]},{type:"input_value",name:"BOOLEAN2",check:"Boolean"}],output:"Boolean",colour:"#59C059"},{type:"number_property",message0:"%1",args0:[{type:"field_number",name:"NUMBER",value:0}],output:"Number",colour:"#59C059"},{type:"text_property",message0:"%1",args0:[{type:"field_input",name:"TEXT",text:"apple"}],output:"String",colour:"#59C059"},{type:"other_sprite_component_values",message0:"get %2 of sprite %1",args0:[{type:"field_dropdown",name:"SPRITE",options:[["Select a sprite","NONE"]]},{type:"field_dropdown",name:"COMPONENT",options:[["X","X"],["Y","Y"],["Direction","Direction"],["Size","Size"]]}],extensions:["dynamic_sprite_menu"],output:"Number",colour:"#5CB1D6"},{type:"set_global_light_intensity",message0:"set global light intensity to %1",args0:[{type:"input_value",name:"INTENSITY"}],previousStatement:null,nextStatement:null,colour:200},{type:"get_global_light_intensity",message0:"global light intensity",output:"Number",colour:200},{type:"set_global_light_color",message0:"set global light color to %1",args0:[{type:"field_colour",name:"COLOR",colour:"#ffffff"}],previousStatement:null,nextStatement:null,colour:200},{type:"set_day_night",message0:"set %1",args0:[{type:"field_dropdown",name:"TIME",options:[["day","day"],["night","night"]]}],previousStatement:null,nextStatement:null,colour:200},{type:"set_variable",message0:"set %1 to %2",args0:[{type:"field_dropdown",name:"VAR",options:[["variable","variable"]]},{type:"input_value",name:"VALUE"}],previousStatement:null,nextStatement:null,colour:"#FF8C1A",extensions:["dynamic_variable_menu"]},{type:"change_variable",message0:"change %1 by %2",args0:[{type:"field_dropdown",name:"VAR",options:[["variable","variable"]]},{type:"input_value",name:"VALUE"}],previousStatement:null,nextStatement:null,colour:"#FF8C1A",extensions:["dynamic_variable_menu"]},{type:"get_variable",message0:"%1",args0:[{type:"field_dropdown",name:"VAR",options:[["variable","variable"]]}],output:null,colour:"#FF8C1A",extensions:["dynamic_variable_menu"]},{type:"set_sprite_variable",message0:"set sprite %1 to %2",args0:[{type:"field_dropdown",name:"VAR",options:[["variable","variable"]]},{type:"input_value",name:"VALUE"}],previousStatement:null,nextStatement:null,colour:"#FF8C1A",tooltip:"Set a variable for this sprite only",extensions:["dynamic_sprite_variable_menu"]},{type:"change_sprite_variable",message0:"change sprite %1 by %2",args0:[{type:"field_dropdown",name:"VAR",options:[["variable","variable"]]},{type:"input_value",name:"VALUE"}],previousStatement:null,nextStatement:null,colour:"#FF8C1A",tooltip:"Change a variable for this sprite only",extensions:["dynamic_sprite_variable_menu"]},{type:"get_sprite_variable",message0:"sprite %1",args0:[{type:"field_dropdown",name:"VAR",options:[["variable","variable"]]}],output:null,colour:"#FF8C1A",tooltip:"Get a variable from this sprite",extensions:["dynamic_sprite_variable_menu"]},{type:"add_to_list",message0:"add %1 to %2",args0:[{type:"input_value",name:"ITEM"},{type:"field_dropdown",name:"LIST",options:[["list","list"]]}],previousStatement:null,nextStatement:null,colour:"#FF6680",extensions:["dynamic_list_menu"]},{type:"delete_from_list",message0:"delete %1 from %2",args0:[{type:"input_value",name:"INDEX"},{type:"field_dropdown",name:"LIST",options:[["list","list"]]}],previousStatement:null,nextStatement:null,colour:"#FF6680",extensions:["dynamic_list_menu"]},{type:"insert_in_list",message0:"insert %1 at %2 of %3",args0:[{type:"input_value",name:"ITEM"},{type:"input_value",name:"INDEX"},{type:"field_dropdown",name:"LIST",options:[["list","list"]]}],previousStatement:null,nextStatement:null,colour:"#FF6680",extensions:["dynamic_list_menu"]},{type:"replace_in_list",message0:"replace item %1 of %2 with %3",args0:[{type:"input_value",name:"INDEX"},{type:"field_dropdown",name:"LIST",options:[["list","list"]]},{type:"input_value",name:"ITEM"}],previousStatement:null,nextStatement:null,colour:"#FF6680",extensions:["dynamic_list_menu"]},{type:"get_from_list",message0:"item %1 of %2",args0:[{type:"input_value",name:"INDEX"},{type:"field_dropdown",name:"LIST",options:[["list","list"]]}],output:null,colour:"#FF6680",extensions:["dynamic_list_menu"]},{type:"list_length",message0:"length of %1",args0:[{type:"field_dropdown",name:"LIST",options:[["list","list"]]}],output:null,colour:"#FF6680",extensions:["dynamic_list_menu"]},{type:"list_contains",message0:"%1 contains %2",args0:[{type:"field_dropdown",name:"LIST",options:[["list","list"]]},{type:"input_value",name:"ITEM"}],output:null,colour:"#FF6680",extensions:["dynamic_list_menu"]},{type:"add_to_sprite_list",message0:"add %1 to sprite %2",args0:[{type:"input_value",name:"ITEM"},{type:"field_dropdown",name:"LIST",options:[["list","list"]]}],previousStatement:null,nextStatement:null,colour:"#FF6680",tooltip:"Add to a list for this sprite only",extensions:["dynamic_sprite_list_menu"]},{type:"delete_from_sprite_list",message0:"delete %1 from sprite %2",args0:[{type:"input_value",name:"INDEX"},{type:"field_dropdown",name:"LIST",options:[["list","list"]]}],previousStatement:null,nextStatement:null,colour:"#FF6680",tooltip:"Delete from a list for this sprite only",extensions:["dynamic_sprite_list_menu"]},{type:"insert_in_sprite_list",message0:"insert %1 at %2 of sprite %3",args0:[{type:"input_value",name:"ITEM"},{type:"input_value",name:"INDEX"},{type:"field_dropdown",name:"LIST",options:[["list","list"]]}],previousStatement:null,nextStatement:null,colour:"#FF6680",tooltip:"Insert into a list for this sprite only",extensions:["dynamic_sprite_list_menu"]},{type:"replace_in_sprite_list",message0:"replace item %1 of sprite %2 with %3",args0:[{type:"input_value",name:"INDEX"},{type:"field_dropdown",name:"LIST",options:[["list","list"]]},{type:"input_value",name:"ITEM"}],previousStatement:null,nextStatement:null,colour:"#FF6680",tooltip:"Replace in a list for this sprite only",extensions:["dynamic_sprite_list_menu"]},{type:"get_from_sprite_list",message0:"item %1 of sprite %2",args0:[{type:"input_value",name:"INDEX"},{type:"field_dropdown",name:"LIST",options:[["list","list"]]}],output:null,colour:"#FF6680",tooltip:"Get from a list for this sprite only",extensions:["dynamic_sprite_list_menu"]},{type:"sprite_list_length",message0:"length of sprite %1",args0:[{type:"field_dropdown",name:"LIST",options:[["list","list"]]}],output:null,colour:"#FF6680",tooltip:"Get length of a list for this sprite only",extensions:["dynamic_sprite_list_menu"]},{type:"sprite_list_contains",message0:"sprite %1 contains %2",args0:[{type:"field_dropdown",name:"LIST",options:[["list","list"]]},{type:"input_value",name:"ITEM"}],output:null,colour:"#FF6680",tooltip:"Check if sprite list contains item",extensions:["dynamic_sprite_list_menu"]}])},setupGenerator=()=>{javascriptGenerator.forBlock.move_sprite=function(t){return`target.move(${javascriptGenerator.valueToCode(t,"STEPS",Order.ATOMIC)||"10"});
`},javascriptGenerator.forBlock.turn=function(t){return`target.rotate(${javascriptGenerator.valueToCode(t,"DEGREE",Order.ATOMIC)||"15"});
`},javascriptGenerator.forBlock.event_stop_all=function(t){return`window.stopProject();
`},javascriptGenerator.forBlock.reset_pos=function(t){return t.getFieldValue("STEPS"),`engine.reset();
`},javascriptGenerator.forBlock.wait_block=function(t){return`if (!window.isRunning) return; 
  await new Promise(res => setTimeout(res, ${javascriptGenerator.valueToCode(t,"SECONDS",Order.ATOMIC)||"1"} * 1000));
`},javascriptGenerator.forBlock.play_sound=function(t){return`target.playSound("${t.getFieldValue("SOUND_NAME")}");
`},javascriptGenerator.forBlock.event_when_flag_clicked=function(t){return""},javascriptGenerator.forBlock.event_when_sprite_clicked=function(t){return""},javascriptGenerator.forBlock.controls_forever=function(t){const n=javascriptGenerator.statementToCode(t,"DO");console.log("[GENERATOR DEBUG] controls_forever - branch:",n);const o=`while (window.isRunning) {
    ${n}
    if (!window.isRunning) break;
    await new Promise(res => setTimeout(res, 10));
  }
`;return console.log("[GENERATOR DEBUG] controls_forever - final code:",o),o},javascriptGenerator.forBlock.controls_if=function(t){const n=javascriptGenerator.valueToCode(t,"CONDITION",Order.NONE)||"false",o=javascriptGenerator.statementToCode(t,"DO");console.log("[GENERATOR DEBUG] controls_if - condition:",n),console.log("[GENERATOR DEBUG] controls_if - doBranch:",o);let r=`if (${n}) {
${o}}
`;return console.log("[GENERATOR DEBUG] controls_if - final code:",r),r},javascriptGenerator.forBlock.controls_if_else=function(t){const n=javascriptGenerator.valueToCode(t,"CONDITION",Order.NONE)||"false",o=javascriptGenerator.statementToCode(t,"DO"),r=javascriptGenerator.statementToCode(t,"ELSE");return`if (${n}) {
${o}} else {
${r}}
`},javascriptGenerator.forBlock.sensing_touching_mouse=function(t){return["target.isMouseOver",javascriptGenerator.ORDER_ATOMIC]},javascriptGenerator.forBlock.touching_edge=function(t){return[`(function() {
    // Default stage dimensions for 9:16 ratio
    let stageWidth = 360;
    let stageHeight = 640;
    let halfWidth = stageWidth / 2;
    let halfHeight = stageHeight / 2;
    
    // Try to get actual camera bounds if available
    if (window.threeCamera) {
      // For perspective camera, calculate visible area at z=0
      const fov = window.threeCamera.fov * Math.PI / 180;
      const distance = Math.abs(window.threeCamera.position.z);
      const height = 2 * Math.tan(fov / 2) * distance;
      const width = height * window.threeCamera.aspect;
      
      halfWidth = width / 2;
      halfHeight = height / 2;
    }
    
    // Add small buffer (10 pixels) for edge detection
    const buffer = 10;
    const spriteHalfSize = (target.size || 100) / 2;
    
    // Check if sprite edges touch or go beyond stage boundaries
    const leftEdge = target.x - spriteHalfSize <= -halfWidth + buffer;
    const rightEdge = target.x + spriteHalfSize >= halfWidth - buffer;
    const topEdge = target.y + spriteHalfSize >= halfHeight - buffer;
    const bottomEdge = target.y - spriteHalfSize <= -halfHeight + buffer;
    
    return leftEdge || rightEdge || topEdge || bottomEdge;
  })()`,Order.ATOMIC]},javascriptGenerator.forBlock.touching_mouse=function(t){return[`(function() {
        // Create a mock event object with current mouse position
        const mockEvent = {
            clientX: window.mouseX,
            clientY: window.mouseY
        };
        
        // Call the existing getSpriteAtMouse function
        const hitSprite = window.getSpriteAtMouse(mockEvent);
        
        // Return true only if hitSprite exists AND matches the target sprite
        // This prevents trying to access .id on null
        return hitSprite !== null && hitSprite.id === target.id;
    })()`,Order.ATOMIC]},javascriptGenerator.forBlock.mouse_button_pressed=function(t){const n=t.getFieldValue("BUTTON");return[`(window.mouseButtons && window.mouseButtons[${JSON.stringify(n)}])`,Order.ATOMIC]},javascriptGenerator.forBlock.sensing_sprite_pressed=function(t){return["target.isClicked",javascriptGenerator.ORDER_ATOMIC]},javascriptGenerator.forBlock.look_next_costume=function(t){return`target.nextCostume();
`},javascriptGenerator.forBlock.look_switch_costume=function(t){return`target.setCostume(${t.getFieldValue("COSTUME")});
`},javascriptGenerator.forBlock.turn_right=function(t){return`target.rotate(${t.getFieldValue("DEGREE")});
`},javascriptGenerator.forBlock.go_to=function(t){const n=javascriptGenerator.valueToCode(t,"X",Order.ATOMIC)||"0",o=javascriptGenerator.valueToCode(t,"Y",Order.ATOMIC)||"0";return`target.goTo(${n}, ${o});
`},javascriptGenerator.forBlock.glide=function(t){const n=javascriptGenerator.valueToCode(t,"SECS",Order.ATOMIC)||"1",o=javascriptGenerator.valueToCode(t,"X",Order.ATOMIC)||"0",r=javascriptGenerator.valueToCode(t,"Y",Order.ATOMIC)||"0";return`await target.glide(${n}, ${o}, ${r});
`},javascriptGenerator.forBlock.point_in_direction=function(t){return`target.pointInDirection(${t.getFieldValue("DIR")});
`},javascriptGenerator.forBlock.rotate_towards=function(t){const n=javascriptGenerator.valueToCode(t,"X",Order.ATOMIC)||"0",o=javascriptGenerator.valueToCode(t,"Y",Order.ATOMIC)||"0";return`target.rotateTowards(${n}, ${o});
`},javascriptGenerator.forBlock.if_on_edge_bounce=function(t){return`target.bounceIfOnEdge();
`},javascriptGenerator.forBlock.say=function(t){const n=javascriptGenerator.valueToCode(t,"TEXT",Order.ATOMIC)||'"Hello!"',o=javascriptGenerator.valueToCode(t,"SECS",Order.ATOMIC)||"2";return`await target.say(${n}, ${o});
`},javascriptGenerator.forBlock.think=function(t){const n=javascriptGenerator.valueToCode(t,"TEXT",Order.ATOMIC)||'"Hmm..."',o=javascriptGenerator.valueToCode(t,"SECS",Order.ATOMIC)||"2";return`await target.think(${n}, ${o});
`},javascriptGenerator.forBlock.switch_backdrop=function(t){const n=t.getFieldValue("BACKDROP");return`engine.switchBackdrop(${JSON.stringify(n)});
`},javascriptGenerator.forBlock.change_size_by=function(t){return`target.changeSizeBy(${javascriptGenerator.valueToCode(t,"DELTA",Order.ATOMIC)||"10"});
`},javascriptGenerator.forBlock.set_size_to=function(t){return`target.setSize(${javascriptGenerator.valueToCode(t,"SIZE",Order.ATOMIC)});
`},javascriptGenerator.forBlock.change_effect_by=function(t){const n=t.getFieldValue("EFFECT"),o=t.getFieldValue("AMOUNT");return`target.changeEffect(${JSON.stringify(n)}, ${o});
`},javascriptGenerator.forBlock.go_to_front_layer=function(t){return`target.move_to_front();
`},javascriptGenerator.forBlock.go_to_back_layer=function(t){return`target.move_to_back();
`},javascriptGenerator.forBlock.show=function(t){return`target.show();
`},javascriptGenerator.forBlock.hide=function(t){return`target.hide();
`},javascriptGenerator.forBlock.set_flip_x=function(t){return`target.setFlipX("${t.getFieldValue("FLIP")}");
`},javascriptGenerator.forBlock.set_flip_y=function(t){return`target.setFlipY("${t.getFieldValue("FLIP")}");
`},javascriptGenerator.forBlock.set_layer_to=function(t){return`target.set_layer_to(${javascriptGenerator.valueToCode(t,"LAYER",Order.ATOMIC)||"1"});
`},javascriptGenerator.forBlock.start_sound=function(t){const n=t.getFieldValue("SOUND_NAME");return`target.playSound(${JSON.stringify(n)});
`},javascriptGenerator.forBlock.play_sound_until_done=function(t){const n=t.getFieldValue("SOUND_NAME");return`await target.playSoundUntilDone(${JSON.stringify(n)});
`},javascriptGenerator.forBlock.stop_all_sounds=function(t){return`engine.stopAllSounds();
`},javascriptGenerator.forBlock.set_volume=function(t){return`target.setVolume(${javascriptGenerator.valueToCode(t,"VOLUME",Order.ATOMIC)||"100"});
`},javascriptGenerator.forBlock.controls_repeat=function(t){const n=javascriptGenerator.valueToCode(t,"TIMES",Order.ATOMIC)||"10",o=javascriptGenerator.statementToCode(t,"DO");return`for (let i=0;i<${n};i++) {
${o}}
`},javascriptGenerator.forBlock.wait_until=function(t){return`while(!(${javascriptGenerator.valueToCode(t,"COND",Order.NONE)||"false"})) { if(!window.isRunning) return; await new Promise(r=>setTimeout(r,10)); }
`},javascriptGenerator.forBlock.create_clone=function(t){const n=t.getFieldValue("CLONEOF");return`target.createClone(${JSON.stringify(n)});
`},javascriptGenerator.forBlock.sensing_touching=function(t){const n=t.getFieldValue("OBJ");return[`target.isTouching(${JSON.stringify(n)})`,Order.ATOMIC]},javascriptGenerator.forBlock.sensing_touching_color=function(t){const n=t.getFieldValue("COLOR");return[`target.isTouchingColor(${JSON.stringify(n)})`,Order.ATOMIC]},javascriptGenerator.forBlock.ask_and_wait=function(t){return`window.latestAnswer = await window.prompt(${javascriptGenerator.valueToCode(t,"QUESTION",Order.ATOMIC)||`"What's your name?"`});
`},javascriptGenerator.forBlock.key_pressed=function(t,n){const o=t.getFieldValue("KEY");return[`(!!(window._keys && window._keys[${JSON.stringify(o)}]))`,n.ORDER_ATOMIC]},javascriptGenerator.forBlock.joystick_input=function(t){return[`window.getJoystickValue("${t.getFieldValue("INPUT")}")`,Order.ATOMIC]},javascriptGenerator.forBlock.distance_to=function(t){const n=t.getFieldValue("SPRITE");return n==="NONE"?["0",Order.ATOMIC]:[`target.distanceTo(${n})`,Order.ATOMIC]},javascriptGenerator.forBlock.sensing_touching_sprite=function(t){const n=t.getFieldValue("SPRITE");return n==="NONE"?["false",Order.ATOMIC]:[`target.isTouchingSprite(${n})`,Order.ATOMIC]},javascriptGenerator.forBlock.touching_sprite=function(t){const n=t.getFieldValue("SPRITE");return n==="NONE"?["false",Order.ATOMIC]:[`target.isTouchingSprite(${n})`,Order.ATOMIC]},javascriptGenerator.forBlock.mouse_x=function(t){return[`(function(){ 
    if (!window.screenToStage) return 0;
    const pos = window.screenToStage(window.mouseX, window.mouseY);
    return Math.round(pos.x);
  })()`,Order.ATOMIC]},javascriptGenerator.forBlock.mouse_y=function(t){return[`(function(){ 
    if (!window.screenToStage) return 0;
    const pos = window.screenToStage(window.mouseX, window.mouseY);
    return Math.round(pos.y);
  })()`,Order.ATOMIC]},javascriptGenerator.forBlock.math_random=function(t){const n=javascriptGenerator.valueToCode(t,"FROM",Order.ATOMIC)||"1";return[`Math.floor(Math.random() * (${javascriptGenerator.valueToCode(t,"TO",Order.ATOMIC)||"10"} - ${n} + 1)) + ${n}`,Order.ATOMIC]},javascriptGenerator.forBlock.text_join=function(t){const n=javascriptGenerator.valueToCode(t,"A",Order.ATOMIC)||'" "',o=javascriptGenerator.valueToCode(t,"B",Order.ATOMIC)||'" "';return[`${n} + ${o}`,Order.ATOMIC]},javascriptGenerator.forBlock.number_property=function(t){return[Number(t.getFieldValue("NUMBER")),Order.ATOMIC]},javascriptGenerator.forBlock.text_property=function(t){return[t.getFieldValue("TEXT"),Order.ATOMIC]},javascriptGenerator.forBlock.sprite_x_position=function(t){return["target.x",Order.ATOMIC]},javascriptGenerator.forBlock.get_x=function(t){return["target.x",Order.ATOMIC]},javascriptGenerator.forBlock.get_y=function(t){return["target.y",Order.ATOMIC]},javascriptGenerator.forBlock.get_size=function(t){return["target.size",Order.ATOMIC]},javascriptGenerator.forBlock.get_direction=function(t){return["target.direction",Order.ATOMIC]},javascriptGenerator.forBlock.sprite_size=function(t){return["target.size",Order.ATOMIC]},javascriptGenerator.forBlock.add=function(t){const n=javascriptGenerator.valueToCode(t,"NUMBER1",Order.ATOMIC)||"0",o=javascriptGenerator.valueToCode(t,"NUMBER2",Order.ATOMIC)||"0";return[`(${n} + ${o})`,Order.ATOMIC]},javascriptGenerator.forBlock.subtract=function(t){const n=javascriptGenerator.valueToCode(t,"NUMBER1",Order.ATOMIC)||"0",o=javascriptGenerator.valueToCode(t,"NUMBER2",Order.ATOMIC)||"0";return[`(${n} - ${o})`,Order.ATOMIC]},javascriptGenerator.forBlock.multiply=function(t){const n=javascriptGenerator.valueToCode(t,"NUMBER1",Order.ATOMIC)||"0",o=javascriptGenerator.valueToCode(t,"NUMBER2",Order.ATOMIC)||"0";return[`(${n} * ${o})`,Order.ATOMIC]},javascriptGenerator.forBlock.divide=function(t){const n=javascriptGenerator.valueToCode(t,"NUMBER1",Order.ATOMIC)||"0",o=javascriptGenerator.valueToCode(t,"NUMBER2",Order.ATOMIC)||"0";return[`(${n} / ${o})`,Order.ATOMIC]},javascriptGenerator.forBlock.broadcast=function(t){return`window.eventBus.emit('${t.getFieldValue("NAME")}');
`},javascriptGenerator.forBlock.event_when_received=function(t){return javascriptGenerator.statementToCode(t,"STACK")},javascriptGenerator.forBlock.other_sprite_component_values=function(t){const n=t.getFieldValue("SPRITE");if(n=="NONE")return["NAN",Order.ATOMIC];const o=spriteManager.sprites.find(i=>i.id.toString()===n.toString());if(!o)return["0",Order.ATOMIC];switch(t.getFieldValue("COMPONENT")){case"X":return[o.x,Order.ATOMIC];case"Y":return[o.y,Order.ATOMIC];case"Direction":return[o.direction,Order.ATOMIC];case"Size":return[o.size,Order.ATOMIC];default:return["0",Order.ATOMIC]}},javascriptGenerator.forBlock.compare=function(t){const n=javascriptGenerator.valueToCode(t,"NUMBER1",Order.ATOMIC)||"0",o=javascriptGenerator.valueToCode(t,"NUMBER2",Order.ATOMIC)||"0",r=t.getFieldValue("COMPARETYPE");let i;switch(r){case"GRATER":i=">";break;case"LESS":i="<";break;case"EQUAL":i="===";break;case"LESS_EQUAL":i="<=";break;case"GREATER_EQUAL":i=">=";break;default:i="=="}return[`(${n} ${i} ${o})`,Order.ATOMIC]},javascriptGenerator.forBlock.not=function(t){return[`!(${javascriptGenerator.valueToCode(t,"BOOLEAN",Order.ATOMIC)||"false"})`,Order.ATOMIC]},javascriptGenerator.forBlock.logic=function(t){const n=javascriptGenerator.valueToCode(t,"BOOLEAN1",Order.ATOMIC)||"false",o=t.getFieldValue("LOGICTYPE"),r=javascriptGenerator.valueToCode(t,"BOOLEAN2",Order.ATOMIC)||"false";let i;switch(o){case"AND":i="&&";break;case"OR":i="||";break;case"XOR":i="^";break;default:i=""}return[`(${n} ${i} ${r})`,Order.ATOMIC]},javascriptGenerator.forBlock.delete_this_clone=function(t){return`if (target.isclone) { target.deleteClone(); return; }
`},javascriptGenerator.forBlock.isthisclone=function(t){return["target.isclone",Order.ATOMIC]},javascriptGenerator.forBlock.event_when_clone_started=function(t){return""},javascriptGenerator.forBlock.set_global_light_intensity=function(t){return`window.setGlobalLightIntensity(${javascriptGenerator.valueToCode(t,"INTENSITY",Order.ATOMIC)||"0.8"});
`},javascriptGenerator.forBlock.get_global_light_intensity=function(t){return["window.getGlobalLightIntensity()",Order.ATOMIC]},javascriptGenerator.forBlock.set_global_light_color=function(t){const n=t.getFieldValue("COLOR");return`window.setGlobalLightColor(${parseInt(n.replace("#","0x"))});
`},javascriptGenerator.forBlock.set_day_night=function(t){return`window.setDayNight(${t.getFieldValue("TIME")==="day"});
`},javascriptGenerator.forBlock.set_variable=function(t){const n=t.getFieldValue("VAR"),o=javascriptGenerator.valueToCode(t,"VALUE",Order.ATOMIC)||"0";return`window.variableManager.setVariable("${n}", ${o}, 'global');
`},javascriptGenerator.forBlock.change_variable=function(t){const n=t.getFieldValue("VAR"),o=javascriptGenerator.valueToCode(t,"VALUE",Order.ATOMIC)||"0";return`window.variableManager.changeVariable("${n}", ${o}, 'global');
`},javascriptGenerator.forBlock.get_variable=function(t){return[`window.variableManager.getVariable("${t.getFieldValue("VAR")}", 'global')`,Order.ATOMIC]},javascriptGenerator.forBlock.set_sprite_variable=function(t){const n=t.getFieldValue("VAR"),o=javascriptGenerator.valueToCode(t,"VALUE",Order.ATOMIC)||"0";return`window.variableManager.setVariable("${n}", ${o}, 'sprite', target.id);
`},javascriptGenerator.forBlock.change_sprite_variable=function(t){const n=t.getFieldValue("VAR"),o=javascriptGenerator.valueToCode(t,"VALUE",Order.ATOMIC)||"0";return`window.variableManager.changeVariable("${n}", ${o}, 'sprite', target.id);
`},javascriptGenerator.forBlock.get_sprite_variable=function(t){return[`window.variableManager.getVariable("${t.getFieldValue("VAR")}", 'sprite', target.id)`,Order.ATOMIC]},javascriptGenerator.forBlock.add_to_list=function(t,n){const o=n.valueToCode(t,"ITEM",Order.ATOMIC)||"0";return`window.listManager.addToList("${t.getFieldValue("LIST")}", ${o}, 'global');
`},javascriptGenerator.forBlock.delete_from_list=function(t,n){const o=n.valueToCode(t,"INDEX",Order.ATOMIC)||"1";return`window.listManager.deleteFromList("${t.getFieldValue("LIST")}", ${o}, 'global');
`},javascriptGenerator.forBlock.insert_in_list=function(t,n){const o=n.valueToCode(t,"ITEM",Order.ATOMIC)||"0",r=n.valueToCode(t,"INDEX",Order.ATOMIC)||"1";return`window.listManager.insertInList("${t.getFieldValue("LIST")}", ${r}, ${o}, 'global');
`},javascriptGenerator.forBlock.replace_in_list=function(t,n){const o=n.valueToCode(t,"INDEX",Order.ATOMIC)||"1",r=t.getFieldValue("LIST"),i=n.valueToCode(t,"ITEM",Order.ATOMIC)||"0";return`window.listManager.replaceInList("${r}", ${o}, ${i}, 'global');
`},javascriptGenerator.forBlock.get_from_list=function(t,n){const o=n.valueToCode(t,"INDEX",Order.ATOMIC)||"1";return[`window.listManager.getFromList("${t.getFieldValue("LIST")}", ${o}, 'global')`,Order.ATOMIC]},javascriptGenerator.forBlock.list_length=function(t){return[`window.listManager.getListLength("${t.getFieldValue("LIST")}", 'global')`,Order.ATOMIC]},javascriptGenerator.forBlock.list_contains=function(t,n){const o=t.getFieldValue("LIST"),r=n.valueToCode(t,"ITEM",Order.ATOMIC)||"0";return[`window.listManager.listContains("${o}", ${r}, 'global')`,Order.ATOMIC]},javascriptGenerator.forBlock.add_to_sprite_list=function(t,n){const o=n.valueToCode(t,"ITEM",Order.ATOMIC)||"0";return`window.listManager.addToList("${t.getFieldValue("LIST")}", ${o}, 'sprite', target.id);
`},javascriptGenerator.forBlock.delete_from_sprite_list=function(t,n){const o=n.valueToCode(t,"INDEX",Order.ATOMIC)||"1";return`window.listManager.deleteFromList("${t.getFieldValue("LIST")}", ${o}, 'sprite', target.id);
`},javascriptGenerator.forBlock.insert_in_sprite_list=function(t,n){const o=n.valueToCode(t,"ITEM",Order.ATOMIC)||"0",r=n.valueToCode(t,"INDEX",Order.ATOMIC)||"1";return`window.listManager.insertInList("${t.getFieldValue("LIST")}", ${r}, ${o}, 'sprite', target.id);
`},javascriptGenerator.forBlock.replace_in_sprite_list=function(t,n){const o=n.valueToCode(t,"INDEX",Order.ATOMIC)||"1",r=t.getFieldValue("LIST"),i=n.valueToCode(t,"ITEM",Order.ATOMIC)||"0";return`window.listManager.replaceInList("${r}", ${o}, ${i}, 'sprite', target.id);
`},javascriptGenerator.forBlock.get_from_sprite_list=function(t,n){const o=n.valueToCode(t,"INDEX",Order.ATOMIC)||"1";return[`window.listManager.getFromList("${t.getFieldValue("LIST")}", ${o}, 'sprite', target.id)`,Order.ATOMIC]},javascriptGenerator.forBlock.sprite_list_length=function(t){return[`window.listManager.getListLength("${t.getFieldValue("LIST")}", 'sprite', target.id)`,Order.ATOMIC]},javascriptGenerator.forBlock.sprite_list_contains=function(t,n){const o=t.getFieldValue("LIST"),r=n.valueToCode(t,"ITEM",Order.ATOMIC)||"0";return[`window.listManager.listContains("${o}", ${r}, 'sprite', target.id)`,Order.ATOMIC]}};class ListManager{constructor(){this.globalLists={},this.spriteLists={}}createList(n,o="global",r=null){return o==="global"?this.globalLists[n]?(console.warn(`Global list "${n}" already exists`),!1):(this.globalLists[n]=[],console.log(`Created global list: ${n}`),!0):o==="sprite"&&r?(this.spriteLists[r]||(this.spriteLists[r]={}),this.spriteLists[r][n]?(console.warn(`Sprite list "${n}" already exists for sprite ${r}`),!1):(this.spriteLists[r][n]=[],console.log(`Created sprite list: ${n} for sprite ${r}`),!0)):!1}deleteList(n,o="global",r=null){if(o==="global"){if(this.globalLists[n])return delete this.globalLists[n],console.log(`Deleted global list: ${n}`),!0}else if(o==="sprite"&&r&&this.spriteLists[r]&&this.spriteLists[r][n])return delete this.spriteLists[r][n],console.log(`Deleted sprite list: ${n} for sprite ${r}`),!0;return!1}getLists(n="global",o=null){return n==="global"?Object.keys(this.globalLists):n==="sprite"&&o?this.spriteLists[o]?Object.keys(this.spriteLists[o]):[]:[]}getList(n,o="global",r=null){return o==="global"?this.globalLists[n]||[]:o==="sprite"&&r?this.spriteLists[r]?this.spriteLists[r][n]||[]:[]:[]}setList(n,o,r="global",i=null){if(r==="global"){if(this.globalLists[n])return this.globalLists[n]=Array.isArray(o)?o:[o],!0}else if(r==="sprite"&&i&&this.spriteLists[i]&&this.spriteLists[i][n])return this.spriteLists[i][n]=Array.isArray(o)?o:[o],!0;return!1}addToList(n,o,r="global",i=null){const s=this.getList(n,r,i);return s.push(o),this.setList(n,s,r,i),s.length}deleteFromList(n,o,r="global",i=null){const s=this.getList(n,r,i);return o>=1&&o<=s.length?(s.splice(o-1,1),this.setList(n,s,r,i),!0):!1}insertInList(n,o,r,i="global",s=null){const l=this.getList(n,i,s);return o>=1&&o<=l.length+1?(l.splice(o-1,0,r),this.setList(n,l,i,s),!0):!1}replaceInList(n,o,r,i="global",s=null){const l=this.getList(n,i,s);return o>=1&&o<=l.length?(l[o-1]=r,this.setList(n,l,i,s),!0):!1}getFromList(n,o,r="global",i=null){const s=this.getList(n,r,i);if(o>=1&&o<=s.length)return s[o-1]}getListLength(n,o="global",r=null){return this.getList(n,o,r).length}listContains(n,o,r="global",i=null){return this.getList(n,r,i).includes(o)}clearSpriteLists(n){this.spriteLists[n]&&(delete this.spriteLists[n],console.log(`Cleared all lists for sprite ${n}`))}clearAll(){for(const n in this.globalLists)this.globalLists[n]=[];for(const n in this.spriteLists)for(const o in this.spriteLists[n])this.spriteLists[n][o]=[];console.log("Cleared all lists - reset to empty arrays")}listToString(n,o="global",r=null){return this.getList(n,o,r).join(", ")}}Extensions.register("dynamic_costume_extension",function(){const n=this.getField("COSTUME");n&&(n.menuGenerator_=function(){const o=window.spriteManager?.activeSprite;return!o||!o.costumes||o.costumes.length===0?[["default","0"]]:o.costumes.map((r,i)=>[r.name||`costume${i+1}`,i.toString()])})});Extensions.register("dynamic_sound_menu",function(){const n=this.getField("SOUND_NAME");n&&(n.menuGenerator_=function(){const o=window.spriteManager?.activeSprite;return!o||!o.sounds||Object.keys(o.sounds).length===0?[["Select a sound","NONE"]]:Object.entries(o.sounds).map(([i,s])=>[i,i])})});Extensions.register("dynamic_sprite_menu",function(){const n=this.getField("SPRITE");n&&(n.menuGenerator_=function(){const o=window.spriteManager?.sprites||[];return o.length===0?[["Select a sprite","NONE"]]:o.map(r=>[r.costumes[r.currentCostumeIndex]?.name||`Sprite ${r.id}`,r.id.toString()])})});Extensions.register("dynamic_variable_menu",function(){const t=this,n=t.getField("VAR");n&&(n.menuGenerator_=function(){const o=window.variableManager?.getVariables("global")||[];return o.length===0?[["Create variable...","NEW_VARIABLE"]]:[["Create variable...","NEW_VARIABLE"],...o.map(r=>[r,r])]},t.setOnChange(function(o){o.type===Events.BLOCK_CHANGE&&o.element==="field"&&o.name==="VAR"&&o.newValue==="NEW_VARIABLE"&&(window.showVariableCreationDialog(),setTimeout(()=>{const r=window.variableManager?.getVariables("global")||[];r.length>0?n.setValue(r[0]):n.setValue("variable")},100))}))});Extensions.register("dynamic_sprite_variable_menu",function(){const t=this,n=t.getField("VAR");n&&(n.menuGenerator_=function(){const o=window.spriteManager?.activeSprite;if(!o)return[["Create variable...","NEW_VARIABLE"]];const r=window.variableManager?.getVariables("sprite",o.id)||[];return r.length===0?[["Create variable...","NEW_VARIABLE"]]:[["Create variable...","NEW_VARIABLE"],...r.map(i=>[i,i])]},t.setOnChange(function(o){o.type===Events.BLOCK_CHANGE&&o.element==="field"&&o.name==="VAR"&&o.newValue==="NEW_VARIABLE"&&(window.showVariableCreationDialog(),setTimeout(()=>{const r=document.getElementById("variableScopeInput");r&&(r.value="sprite")},100),setTimeout(()=>{const r=window.spriteManager?.activeSprite;if(r){const i=window.variableManager?.getVariables("sprite",r.id)||[];i.length>0?n.setValue(i[0]):n.setValue("variable")}},200))}))});Extensions.register("dynamic_list_menu",function(){const t=this,n=t.getField("LIST");n&&(n.menuGenerator_=function(){const o=window.listManager?.getLists("global")||[];return o.length===0?[["Create list...","NEW_LIST"]]:[["Create list...","NEW_LIST"],...o.map(r=>[r,r])]},t.setOnChange(function(o){o.type===Events.BLOCK_CHANGE&&o.element==="field"&&o.name==="LIST"&&o.newValue==="NEW_LIST"&&(window.showListCreationDialog(),setTimeout(()=>{const r=window.listManager?.getLists("global")||[];r.length>0?n.setValue(r[0]):n.setValue("list")},100))}))});Extensions.register("dynamic_sprite_list_menu",function(){const t=this,n=t.getField("LIST");n&&(n.menuGenerator_=function(){const o=window.spriteManager?.activeSprite;if(!o)return[["Create list...","NEW_LIST"]];const r=window.listManager?.getLists("sprite",o.id)||[];return r.length===0?[["Create list...","NEW_LIST"]]:[["Create list...","NEW_LIST"],...r.map(i=>[i,i])]},t.setOnChange(function(o){o.type===Events.BLOCK_CHANGE&&o.element==="field"&&o.name==="LIST"&&o.newValue==="NEW_LIST"&&(window.showListCreationDialog(),setTimeout(()=>{const r=document.getElementById("listScopeInput");r&&(r.value="sprite")},100),setTimeout(()=>{const r=window.spriteManager?.activeSprite;if(r){const i=window.listManager?.getLists("sprite",r.id)||[];i.length>0?n.setValue(i[0]):n.setValue("list")}},200))}))});window.spriteManager=spriteManager;window.Sprite=Sprite;window.variableManager=variableManager;window.listManager=new ListManager;window.projectManager=projectManager;window.refreshAllDropdowns=function(){window.workspace&&window.workspace.getAllBlocks().forEach(t=>{(t.type==="look_switch_costume"||t.type==="play_sound"||t.type==="start_sound"||t.type==="play_sound_until_done"||t.type==="touching_sprite"||t.type==="distance_to"||t.type==="other_sprite_component_values"||t.type==="set_variable"||t.type==="change_variable"||t.type==="get_variable"||t.type==="set_sprite_variable"||t.type==="change_sprite_variable"||t.type==="get_sprite_variable"||t.type==="add_to_list"||t.type==="delete_from_list"||t.type==="insert_in_list"||t.type==="replace_in_list"||t.type==="get_from_list"||t.type==="list_length"||t.type==="list_contains"||t.type==="add_to_sprite_list"||t.type==="delete_from_sprite_list"||t.type==="insert_in_sprite_list"||t.type==="replace_in_sprite_list"||t.type==="get_from_sprite_list"||t.type==="sprite_list_length"||t.type==="sprite_list_contains")&&Events.fire(t,Events.BLOCK_CHANGE)})};window.eventBus=new EventEmitter;window.cloneEventListeners=new Map;let renderer,stageCanvas,threeScene,threeCamera,raycaster,mouse,globalAmbientLight,globalDirectionalLight,globalLightIntensity=1.8,isDragging=!1,draggedSprite=null,dragOffset={x:0,y:0};function initThree(){if(stageCanvas=document.getElementById("stageCanvas"),!stageCanvas){console.error("stageCanvas element not found");return}let t=stageCanvas.clientWidth,n=stageCanvas.clientHeight;(!t||!n||t===0||n===0)&&(t=360,n=640,stageCanvas.style.width=t+"px",stageCanvas.style.height=n+"px");const o=9/16,r=t/n;Math.abs(r-o)>.01&&(n=t/o,stageCanvas.style.height=n+"px"),renderer=new WebGLRenderer({canvas:stageCanvas,alpha:!0,antialias:!0,preserveDrawingBuffer:!1}),renderer.setPixelRatio(Math.min(window.devicePixelRatio,2)),renderer.setSize(t,n,!1),renderer.setClearColor(938,0),threeScene=new Scene,window.threeScene=threeScene,window.globalAmbientLight=new AmbientLight(16777215,.5),threeScene.add(window.globalAmbientLight);const i=75,s=t/n,l=.1,a=1e3;threeCamera=new PerspectiveCamera(i,s,l,a),threeCamera.position.set(0,0,300),threeCamera.lookAt(0,0,0),window.threeCamera=threeCamera,console.log("Camera setup:",{type:"Perspective",fov:threeCamera.fov,aspect:threeCamera.aspect,near:threeCamera.near,far:threeCamera.far,position:threeCamera.position}),globalAmbientLight=new AmbientLight(16777215,globalLightIntensity),threeScene.add(globalAmbientLight),window.globalAmbientLight=globalAmbientLight,globalDirectionalLight=new DirectionalLight(16777215,globalLightIntensity),globalDirectionalLight.position.set(0,10,0),globalDirectionalLight.target.position.set(0,0,0),globalDirectionalLight.castShadow=!1,threeScene.add(globalDirectionalLight),threeScene.add(globalDirectionalLight.target),window.globalDirectionalLight=globalDirectionalLight,renderer.sortObjects=!0,raycaster=new Raycaster,mouse=new Vector2,raycaster.params={Mesh:{threshold:0}},stageCanvas.addEventListener("mousemove",d=>{window.mouseX=d.clientX,window.mouseY=d.clientY}),window.__THREE_ANIM_STARTED__||(window.__THREE_ANIM_STARTED__=!0,animate())}window.mouseX=0;window.mouseY=0;window.mouseButtons={left:!1,right:!1};document.addEventListener("mousedown",t=>{t.button===0&&(window.mouseButtons.left=!0),t.button===2&&(window.mouseButtons.right=!0)});document.addEventListener("mouseup",t=>{t.button===0&&(window.mouseButtons.left=!1),t.button===2&&(window.mouseButtons.right=!1)});document.addEventListener("contextmenu",t=>{t.preventDefault()});function animate(){if(requestAnimationFrame(animate),spriteManager&&spriteManager.sprites&&spriteManager.sprites.forEach(t=>{t.update(),t.updateComponents(.016)}),spriteManager&&spriteManager.sprites){const t=new Set;spriteManager.sprites.forEach(n=>{n.instancedMesh&&!t.has(n.instancedMesh)&&(t.add(n.instancedMesh),n.instancedMesh.instanceMatrix.needsUpdate=!0)})}renderer&&threeScene&&threeCamera&&renderer.render(threeScene,threeCamera)}function getSpriteAtMouse(t){if(!stageCanvas||!raycaster||!threeCamera||!spriteManager)return null;const n=stageCanvas.getBoundingClientRect();mouse.x=(t.clientX-n.left)/n.width*2-1,mouse.y=-((t.clientY-n.top)/n.height)*2+1,raycaster.setFromCamera(mouse,threeCamera);const o=spriteManager.sprites.filter(i=>i.mesh&&i.visible).map(i=>i.mesh),r=raycaster.intersectObjects(o,!0);if(r.length>0){r.sort((l,a)=>l.distance-a.distance);const s=r[0].object.userData.spriteId;return spriteManager.sprites.find(l=>l.id===s)}return null}window.getSpriteAtMouse=getSpriteAtMouse;function screenToStage(t,n){if(!stageCanvas||!threeCamera)return{x:0,y:0};const o=stageCanvas.getBoundingClientRect(),r=new Vector3;r.x=(t-o.left)/o.width*2-1,r.y=-((n-o.top)/o.height)*2+1,r.unproject(threeCamera);const i=r.sub(threeCamera.position).normalize(),s=-threeCamera.position.z/i.z,l=threeCamera.position.clone().add(i.multiplyScalar(s));return{x:l.x,y:l.y}}window.screenToStage=screenToStage;function onCanvasMouseDown(t){if(!window.isRunning){const n=getSpriteAtMouse(t);if(n){isDragging=!0,draggedSprite=n;const o=screenToStage(t.clientX,t.clientY);if(dragOffset.x=n.x-o.x,dragOffset.y=n.y-o.y,stageCanvas.style.cursor="grabbing",t.preventDefault(),n!==spriteManager.activeSprite){const r=spriteManager.activeSprite;if(r&&window.workspace){const i=serialization.workspaces.save(window.workspace);r.workspaceData=JSON.stringify(i)}if(spriteManager.activeSprite=n,renderSpriteList(),renderAssetPanels(),window.refreshAllDropdowns(),window.workspace)if(n.workspaceData&&n.workspaceData!=="")try{const i=typeof n.workspaceData=="string"?JSON.parse(n.workspaceData):n.workspaceData;serialization.workspaces.load(i,window.workspace)}catch{console.warn("Invalid workspace data for sprite, clearing workspace"),window.workspace.clear()}else window.workspace.clear();updateInspector()}}}}function onCanvasMouseMove(t){if(isDragging&&draggedSprite){const n=screenToStage(t.clientX,t.clientY);draggedSprite.goTo(n.x+dragOffset.x,n.y+dragOffset.y),updateInspector(),t.preventDefault()}else{const n=getSpriteAtMouse(t);n&&!window.isRunning?(stageCanvas.style.cursor="grab",spriteManager.sprites.forEach(o=>{o.isMouseOver=o===n})):(stageCanvas.style.cursor="crosshair",spriteManager.sprites.forEach(o=>{o.isMouseOver=!1}))}}function onCanvasMouseUp(t){isDragging&&(isDragging=!1,draggedSprite=null,stageCanvas.style.cursor="crosshair")}function onCanvasClick(t){if(!stageCanvas||!raycaster||!threeCamera||!spriteManager||isDragging)return;const n=getSpriteAtMouse(t);n&&(n.isClicked=!0,window.eventBus&&window.eventBus.emit("SPRITE_CLICKED",n),setTimeout(()=>{n.isClicked=!1},200))}function onWindowResize(){if(!stageCanvas||!renderer||!threeCamera)return;let t=stageCanvas.clientWidth,n=stageCanvas.clientHeight;(!t||!n||t===0||n===0)&&(t=360,n=640);const o=9/16,r=t/n;Math.abs(r-o)>.01&&(n=t/o),threeCamera.aspect=t/n,threeCamera.updateProjectionMatrix(),renderer.setSize(t,n,!1)}window.setGlobalLightIntensity=function(t){globalLightIntensity=Math.max(0,Math.min(2,Number(t))),globalAmbientLight&&(globalAmbientLight.intensity=globalLightIntensity),globalDirectionalLight&&(globalDirectionalLight.intensity=globalLightIntensity*.5),console.log("Global light intensity set to:",globalLightIntensity)};window.getGlobalLightIntensity=function(){return globalLightIntensity};window.setGlobalLightColor=function(t){globalAmbientLight&&globalAmbientLight.color.setHex(t),globalDirectionalLight&&globalDirectionalLight.color.setHex(t),console.log("Global light color set to:",t)};window.injectBlockly=function(){if(window.blockyinjected)return;defineBlocks(),setupGenerator();const t=document.getElementById("blocklyDiv");if(!t){console.error("blocklyDiv not found");return}const n=inject(t,{toolbox:{kind:"categoryToolbox",contents:[{kind:"category",name:"Events",colour:"#FFAB19",contents:[{kind:"block",type:"event_when_flag_clicked"},{kind:"block",type:"event_when_clone_started"},{kind:"block",type:"broadcast"},{kind:"block",type:"event_when_received"},{kind:"block",type:"event_stop_all"}]},{kind:"category",name:"Motion",colour:"#4C97FF",contents:[{kind:"block",type:"move_sprite"},{kind:"block",type:"turn"},{kind:"block",type:"go_to"},{kind:"block",type:"glide"},{kind:"block",type:"point_in_direction"},{kind:"block",type:"rotate_towards"},{kind:"block",type:"if_on_edge_bounce"}]},{kind:"category",name:"Looks",colour:"#9966FF",contents:[{kind:"block",type:"say"},{kind:"block",type:"think"},{kind:"block",type:"look_next_costume"},{kind:"block",type:"look_switch_costume"},{kind:"block",type:"switch_backdrop"},{kind:"block",type:"change_size_by"},{kind:"block",type:"set_size_to"},{kind:"block",type:"go_to_front_layer"},{kind:"block",type:"go_to_back_layer"},{kind:"block",type:"set_layer_to"},{kind:"block",type:"show"},{kind:"block",type:"hide"},{kind:"block",type:"set_flip_x"},{kind:"block",type:"set_flip_y"},{kind:"block",type:"change_effect_by"}]},{kind:"category",name:"Sound",colour:"#CF63CF",contents:[{kind:"block",type:"play_sound"},{kind:"block",type:"start_sound"},{kind:"block",type:"play_sound_until_done"},{kind:"block",type:"stop_all_sounds"},{kind:"block",type:"set_volume"}]},{kind:"category",name:"Control",colour:"#5ba55b",contents:[{kind:"block",type:"controls_if"},{kind:"block",type:"controls_if_else"},{kind:"block",type:"controls_repeat"},{kind:"block",type:"controls_forever"},{kind:"block",type:"wait_block"},{kind:"block",type:"wait_until"},{kind:"block",type:"create_clone"},{kind:"block",type:"delete_this_clone"}]},{kind:"category",name:"Sensing",colour:"#5CB1D6",contents:[{kind:"block",type:"touching"},{kind:"block",type:"touching_sprite"},{kind:"block",type:"sensing_touching_color"},{kind:"block",type:"ask_and_wait"},{kind:"block",type:"key_pressed"},{kind:"block",type:"joystick_input"},{kind:"block",type:"touching_sprite"},{kind:"block",type:"touching_edge"},{kind:"block",type:"touching_mouse"},{kind:"block",type:"mouse_button_pressed"},{kind:"block",type:"mouse_x"},{kind:"block",type:"mouse_y"},{kind:"block",type:"distance_to"},{kind:"block",type:"get_x"},{kind:"block",type:"get_y"},{kind:"block",type:"get_direction"},{kind:"block",type:"get_size"},{kind:"block",type:"other_sprite_component_values"},{kind:"block",type:"isthisclone"}]},{kind:"category",name:"Operators",colour:"#59C059",contents:[{kind:"block",type:"add"},{kind:"block",type:"subtract"},{kind:"block",type:"multiply"},{kind:"block",type:"divide"},{kind:"block",type:"compare"},{kind:"block",type:"not"},{kind:"block",type:"logic"},{kind:"block",type:"math_random"},{kind:"block",type:"text_join"},{kind:"block",type:"number_property"},{kind:"block",type:"text_property"}]},{kind:"category",name:"Global Light",colour:200,contents:[{kind:"block",type:"set_global_light_intensity"},{kind:"block",type:"get_global_light_intensity"}]},{kind:"category",name:"Variables",colour:"#FF8C1A",contents:[{kind:"button",text:"Make a Variable",callbackKey:"CREATE_VARIABLE"},{kind:"sep"},{kind:"block",type:"set_variable"},{kind:"block",type:"change_variable"},{kind:"block",type:"get_variable"},{kind:"block",type:"set_sprite_variable"},{kind:"block",type:"change_sprite_variable"},{kind:"block",type:"get_sprite_variable"}]},{kind:"category",name:"Lists",colour:"#FF6680",contents:[{kind:"button",text:"Make a List",callbackKey:"CREATE_LIST"},{kind:"sep"},{kind:"block",type:"add_to_list"},{kind:"block",type:"delete_from_list"},{kind:"block",type:"insert_in_list"},{kind:"block",type:"replace_in_list"},{kind:"block",type:"get_from_list"},{kind:"block",type:"list_length"},{kind:"block",type:"list_contains"},{kind:"block",type:"add_to_sprite_list"},{kind:"block",type:"delete_from_sprite_list"},{kind:"block",type:"insert_in_sprite_list"},{kind:"block",type:"replace_in_sprite_list"},{kind:"block",type:"get_from_sprite_list"},{kind:"block",type:"sprite_list_length"},{kind:"block",type:"sprite_list_contains"}]}]},grid:{spacing:20,length:3,colour:"#334155",snap:!0},zoom:{controls:!0,wheel:!0,startScale:1,maxScale:3,minScale:.3,scaleSpeed:1.2},trashcan:!0,theme:{componentStyles:{workspaceBackgroundColour:"#1e293b",toolboxBackgroundColour:"#334155",flyoutBackgroundColour:"#475569",scrollbarColour:"#64748b",scrollbarOpacity:.5,componentMutator:{colour:"#6366f1"}},blockStyles:{colour:"#6366f1",text:"#f8fafc"},categoryStyles:{logic_category:{colour:"#3b82f6"},loop_category:{colour:"#10b981"},math_category:{colour:"#f59e0b"},text_category:{colour:"#8b5cf6"},lists_category:{colour:"#ef4444"},colour_category:{colour:"#ec4899"},variables_category:{colour:"#06b6d4"},functions_category:{colour:"#84cc16"}}}});window.workspace=n,window.blockyinjected=!0,n.registerButtonCallback("CREATE_VARIABLE",function(o){showVariableCreationDialog()}),n.registerButtonCallback("CREATE_LIST",function(o){showListCreationDialog()}),n.addChangeListener(o=>{const r=spriteManager.activeSprite;if(r&&window.workspace){const i=serialization.workspaces.save(window.workspace);r.workspaceData=JSON.stringify(i)}(o.type===Events.BLOCK_CREATE||o.type===Events.BLOCK_CHANGE)&&n.getAllBlocks(!1).forEach(s=>{if(s.type==="look_switch_costume"||s.type==="play_sound"||s.type==="start_sound"||s.type==="play_sound_until_done"||s.type==="sensing_touching_sprite"||s.type==="other_sprite_component_values"){const l=Object.keys(s.inputList[0]||{});if(l.length>0){const a=l[0],d=s.getFieldValue(a);d!==void 0&&s.setFieldValue(d,a)}}})})};window.runCode=async function(){if(console.log(`[RUNCODE DEBUG] runCode() called at ${new Date().toISOString()}`),console.log("[RUNCODE DEBUG] Call stack:",new Error().stack),!window.workspace){console.warn("No workspace available");return}if(spriteManager.activeSprite){const t=serialization.workspaces.save(window.workspace);spriteManager.activeSprite.workspaceData=JSON.stringify(t)}spriteManager.sprites.forEach(t=>{t.saveStartPosition(),t.savesize(),t.savedirection(),t.savecostume(),t.savelayer(),t.saveflip(),t.savevisible()}),window.isRunning=!0,document.body.classList.add("play-mode"),window.eventBus.removeAllListeners(),window.cloneEventListeners&&window.cloneEventListeners.clear(),console.log(`Before workspace processing: ${spriteManager.sprites.length} sprites`),spriteManager.sprites.forEach(t=>{console.log(`  - Sprite: ${t.id}, isclone: ${t.isclone}`)}),console.log(`Starting workspace processing for ${spriteManager.sprites.length} sprites`);for(const sprite of spriteManager.sprites){if(console.log(`Processing sprite ${sprite.id}, isclone: ${sprite.isclone}, hasWorkspace: ${!!sprite.workspaceData}`),sprite.isclone){console.log(`Skipping clone ${sprite.id}`);continue}if(console.log(`Processing original sprite ${sprite.id}`),sprite.workspaceData&&sprite.workspaceData!==""){console.log(`Loading workspace for sprite ${sprite.id}`);try{const workspaceData=typeof sprite.workspaceData=="string"?JSON.parse(sprite.workspaceData):sprite.workspaceData,tempWorkspace=new Workspace;serialization.workspaces.load(workspaceData,tempWorkspace);const topBlocks=tempWorkspace.getTopBlocks(!1);console.log(`Sprite ${sprite.id}: Found ${topBlocks.length} top-level blocks`);const target=sprite;topBlocks.forEach(block=>{if(console.log(`Sprite ${sprite.id}: Processing block type: ${block.type}`),block.type==="event_when_flag_clicked"){console.log(`[FLAG DEBUG] Processing flag clicked event for sprite ${sprite.id}`);const stackCode=javascriptGenerator.blockToCode(block);console.log(`Sprite ${sprite.id}: Flag clicked code generated:`,stackCode),console.log(`Sprite ${sprite.id}: Generated code length: ${stackCode.length} characters`),stackCode&&(console.log(`[FLAG DEBUG] About to execute flag clicked code for sprite ${sprite.id}`),(async()=>{try{console.log(`[FLAG DEBUG] Starting execution of flag clicked code for sprite ${sprite.id}`),eval(`(async () => { ${stackCode} })()`),console.log(`Sprite ${sprite.id}: Flag clicked code executed successfully`)}catch(t){console.error("Error executing flag clicked code:",t)}})())}else if(block.type==="event_when_sprite_clicked"){const stackCode=javascriptGenerator.blockToCode(block);if(stackCode){const clickHandler=clickedSprite=>{if((clickedSprite===sprite||clickedSprite.parentSpriteId===sprite.id)&&window.isRunning){console.log(`Sprite clicked: ${clickedSprite.id} (parent: ${sprite.id})`);const target=clickedSprite;(async()=>{try{eval(`(async () => { ${stackCode} })()`)}catch(t){console.error("Error executing sprite click code:",t)}})()}};window.cloneEventListeners.set(`${sprite.id}_click`,clickHandler),window.eventBus.on("SPRITE_CLICKED",clickHandler)}}else if(block.type==="event_when_key_pressed"){const stackCode=javascriptGenerator.blockToCode(block);if(stackCode){const keyOption=block.getFieldValue("KEY_OPTION"),keyHandler=e=>{if(!window.isRunning)return;let keyMatches=!1;if((keyOption==="any"||keyOption==="space"&&(e.key===" "||e.code==="Space")||e.key===keyOption||e.code===keyOption)&&(keyMatches=!0),keyMatches){console.log(`Key pressed: ${e.key} for sprite ${sprite.id}`);const target=sprite;(async()=>{try{eval(`(async () => { ${stackCode} })()`)}catch(t){console.error("Error executing key press code:",t)}})()}};window.cloneEventListeners.set(`${sprite.id}_key_${keyOption}`,keyHandler),document.addEventListener("keydown",keyHandler)}}else if(block.type==="event_when_received"){const eventName=block.getFieldValue("BROADCAST_OPTION"),stackCode=javascriptGenerator.statementToCode(block,"STACK"),handler=()=>{if(!window.isRunning)return;const target=sprite;try{eval(`(async () => { ${stackCode} })()`)}catch(t){console.error("Error executing broadcast receive code:",t)}};window.cloneEventListeners.set(`${sprite.id}_broadcast_${eventName}`,handler),window.eventBus.on(eventName,handler)}else if(block.type==="event_when_clone_started"){const stackCode=javascriptGenerator.statementToCode(block,"STACK"),handler=newClone=>{console.log(`[CLONE DEBUG] Clone startup handler triggered for sprite ${sprite.id}, clone ${newClone.id}`),(async()=>{const target=newClone;try{console.log(`[CLONE DEBUG] Executing clone startup code for ${newClone.id}`),eval(`(async () => { ${stackCode} })()`),console.log(`[CLONE DEBUG] Clone startup code executed successfully for ${newClone.id}`)}catch(t){console.error("Error executing clone startup code for",newClone.id,":",t)}})()},handlerKey=`${sprite.id}_clone_start`;window.cloneEventListeners.set(handlerKey,handler),window.eventBus.listenerCount(`CLONE_CREATED_${sprite.id}`)?console.log(`Clone startup handler already exists for sprite ${sprite.id}, skipping registration`):(window.eventBus.on(`CLONE_CREATED_${sprite.id}`,handler),console.log(`Registered clone startup handler for sprite ${sprite.id}`))}}),tempWorkspace.dispose()}catch(t){console.error("Error loading workspace for sprite:",sprite.id,t)}}}};window.processWorkspaces=function(){if(console.log(`[WORKSPACE DEBUG] processWorkspaces() called at ${new Date().toISOString()}`),console.log("[WORKSPACE DEBUG] Call stack:",new Error().stack),!window.workspace){console.warn("No workspace available");return}if(spriteManager.activeSprite){const t=serialization.workspaces.save(window.workspace);spriteManager.activeSprite.workspaceData=JSON.stringify(t)}spriteManager.sprites.forEach(t=>{t.saveStartPosition(),t.savesize(),t.savedirection(),t.savecostume(),t.savelayer(),t.saveflip(),t.savevisible()}),window.isRunning=!0,document.body.classList.add("play-mode"),window.eventBus.removeAllListeners(),window.cloneEventListeners&&window.cloneEventListeners.clear(),console.log(`Before workspace processing: ${spriteManager.sprites.length} sprites`),spriteManager.sprites.forEach(t=>{console.log(`  - Sprite: ${t.id}, isclone: ${t.isclone}`)}),console.log(`Starting workspace processing for ${spriteManager.sprites.length} sprites`);for(const sprite of spriteManager.sprites){if(console.log(`Processing sprite ${sprite.id}, isclone: ${sprite.isclone}, hasWorkspace: ${!!sprite.workspaceData}`),sprite.isclone){console.log(`Skipping clone ${sprite.id}`);continue}if(console.log(`Processing original sprite ${sprite.id}`),sprite.workspaceData&&sprite.workspaceData!==""){console.log(`Loading workspace for sprite ${sprite.id}`);try{const workspaceData=typeof sprite.workspaceData=="string"?JSON.parse(sprite.workspaceData):sprite.workspaceData,tempWorkspace=new Workspace;serialization.workspaces.load(workspaceData,tempWorkspace);const topBlocks=tempWorkspace.getTopBlocks(!1);console.log(`Sprite ${sprite.id}: Found ${topBlocks.length} top-level blocks`);const target=sprite;topBlocks.forEach(block=>{if(console.log(`Sprite ${sprite.id}: Processing block type: ${block.type}`),block.type==="event_when_flag_clicked"){console.log(`[FLAG DEBUG] Processing flag clicked event for sprite ${sprite.id}`);const stackCode=javascriptGenerator.blockToCode(block);console.log(`Sprite ${sprite.id}: Flag clicked code generated:`,stackCode),console.log(`Sprite ${sprite.id}: Generated code length: ${stackCode.length} characters`),stackCode&&(console.log(`[FLAG DEBUG] About to execute flag clicked code for sprite ${sprite.id}`),(async()=>{try{console.log(`[FLAG DEBUG] Starting execution of flag clicked code for sprite ${sprite.id}`),eval(`(async () => { ${stackCode} })()`),console.log(`Sprite ${sprite.id}: Flag clicked code executed successfully`)}catch(t){console.error("Error executing flag clicked code:",t)}})())}else if(block.type==="event_when_sprite_clicked"){const t=javascriptGenerator.blockToCode(block);if(t){const n=o=>{(o===sprite||o.parentSpriteId===sprite.id)&&window.isRunning&&(console.log(`Sprite clicked: ${o.id} (parent: ${sprite.id})`),(async()=>{try{await new Function("target",`
                        return (async () => {
                          ${t}
                        })();
                      `)(o)}catch(r){console.error("Error executing sprite clicked code for",o.id,":",r)}})())};window.cloneEventListeners.set(`${sprite.id}_click`,n),window.eventBus.on("SPRITE_CLICKED",n)}}else if(block.type==="event_when_received"){const messageName=block.getFieldValue("NAME"),stackCode=javascriptGenerator.blockToCode(block);stackCode&&window.eventBus.on(messageName,()=>{window.isRunning&&(async()=>{try{eval(`(async () => { ${stackCode} })()`)}catch(t){console.error("Error executing broadcast receive code:",t)}})()})}else if(block.type==="event_when_clone_started"){const stackCode=javascriptGenerator.statementToCode(block,"STACK"),handler=newClone=>{console.log(`[CLONE DEBUG] Clone startup handler triggered for sprite ${sprite.id}, clone ${newClone.id}`),(async()=>{const target=newClone;try{console.log(`[CLONE DEBUG] Executing clone startup code for ${newClone.id}`),eval(`(async () => { ${stackCode} })()`),console.log(`[CLONE DEBUG] Clone startup code executed successfully for ${newClone.id}`)}catch(t){console.error("Error executing clone startup code for",newClone.id,":",t)}})()},handlerKey=`${sprite.id}_clone_start`;window.cloneEventListeners.set(handlerKey,handler),window.eventBus.listenerCount(`CLONE_CREATED_${sprite.id}`)?console.log(`Clone startup handler already exists for sprite ${sprite.id}, skipping registration`):(window.eventBus.on(`CLONE_CREATED_${sprite.id}`,handler),console.log(`Registered clone startup handler for sprite ${sprite.id}`))}}),tempWorkspace.dispose()}catch(t){console.error("Error loading workspace for sprite:",sprite.id,t)}}}};window.stopProject=function(){if(window.isRunning=!1,spriteManager&&spriteManager.deleteAllClones){console.log("About to delete all clones"),spriteManager.sprites.forEach(n=>{console.log(`Sprite before deletion: ${n.id}, isclone: ${n.isclone}`)}),spriteManager.deleteAllClones(),console.log("Finished deleting clones");const t=spriteManager.sprites.filter(n=>n.isclone);console.log(`Remaining clones after cleanup: ${t.length}`)}document.body.classList.remove("play-mode"),spriteManager.sprites.forEach(t=>{t.isclone||t.goToStartPosition()}),window.variableManager&&window.variableManager.clearAll(),window.listManager&&window.listManager.clearAll(),window.cloneEventListeners&&(window.cloneEventListeners.forEach((t,n)=>{if(n.includes("_click"))window.eventBus.off("SPRITE_CLICKED",t);else if(n.includes("_clone_start")){const o=n.split("_clone_start")[0];window.eventBus.off(`CLONE_CREATED_${o}`,t)}else if(n.includes("clone_start")){const o=n.split("_clone_start");if(o.length>0){const r=o[0];window.eventBus.off(`CLONE_CREATED_${r}`,t)}}}),window.cloneEventListeners.clear()),window.eventBus.removeAllListeners()};window.renderSpriteList=function(){const t=document.getElementById("spriteList");t&&(t.innerHTML="",spriteManager.sprites.forEach(n=>{if(n.isclone)return;const o=document.createElement("div");o.className="sprite-item",n===spriteManager.activeSprite&&o.classList.add("selected");const r=document.createElement("img");r.className="sprite-icon",r.src=n.costumes[n.currentCostumeIndex]?.url||"",r.alt=`Sprite ${n.id}`;const i=document.createElement("div");i.className="sprite-name",i.textContent=n.costumes[n.currentCostumeIndex]?.name||`Sprite ${n.id}`,i.style.fontSize="12px",i.style.marginTop="4px",i.style.textAlign="center",i.style.cursor="pointer",i.addEventListener("dblclick",s=>{s.stopPropagation();const l=n.costumes[n.currentCostumeIndex]?.name||`Sprite ${n.id}`,a=prompt("Enter new sprite name:",l);a&&a.trim()!==l&&(n.costumes[n.currentCostumeIndex].name=a.trim(),renderSpriteList(),renderAssetPanels())}),o.appendChild(r),o.appendChild(i),o.addEventListener("click",()=>{const s=spriteManager.activeSprite;if(s&&window.workspace){const l=serialization.workspaces.save(window.workspace);s.workspaceData=JSON.stringify(l)}if(spriteManager.activeSprite=n,renderSpriteList(),renderAssetPanels(),window.workspace){if(n.workspaceData&&n.workspaceData!=="")try{const l=typeof n.workspaceData=="string"?JSON.parse(n.workspaceData):n.workspaceData;serialization.workspaces.load(l,window.workspace)}catch{console.warn("Invalid workspace data for sprite, clearing workspace"),window.workspace.clear()}else window.workspace.clear();setTimeout(()=>{window.workspace.getAllBlocks(!1).forEach(a=>{if(a.type==="look_switch_costume"||a.type==="play_sound"||a.type==="start_sound"||a.type==="play_sound_until_done"||a.type==="sensing_touching_sprite"||a.type==="other_sprite_component_values"){const d=Object.keys(a.inputList[0]||{});if(d.length>0){const c=d[0],u=a.getFieldValue(c);u!==void 0&&a.setFieldValue(u,c)}}})},100)}updateInspector()}),t.appendChild(o)}))};window.renderAssetPanels=function(){if(!spriteManager.activeSprite)return;const t=document.getElementById("costumeList");t&&spriteManager.activeSprite&&spriteManager.activeSprite.costumes&&(t.innerHTML="",spriteManager.activeSprite.costumes.forEach((o,r)=>{const i=document.createElement("div");i.className="asset-thumb-container";const s=document.createElement("img");s.src=o.url,s.className="costume-thumb",s.style.width="50px",s.style.height="50px",s.style.border=r===spriteManager.activeSprite.currentCostumeIndex?"2px solid var(--success)":"1px solid var(--border)",s.alt=o.name,s.addEventListener("click",()=>{spriteManager.activeSprite.setCostume(r),renderAssetPanels()}),s.addEventListener("dblclick",()=>{const l=prompt(`Rename costume "${o.name}":`,o.name);if(l&&l.trim()&&l.trim()!==o.name){if(spriteManager.activeSprite.costumes.findIndex((d,c)=>c!==r&&d.name.toLowerCase()===l.trim().toLowerCase())!==-1){alert(`A costume named "${l.trim()}" already exists for this sprite. Please choose a different name.`);return}o.name=l.trim(),renderAssetPanels(),window.refreshAllDropdowns()}}),i.appendChild(s),t.appendChild(i)})),window.workspace&&window.workspace.getAllBlocks().forEach(o=>{(o.type==="look_switch_costume"||o.type==="play_sound"||o.type==="start_sound"||o.type==="play_sound_until_done"||o.type==="touching_sprite"||o.type==="distance_to"||o.type==="other_sprite_component_values")&&Events.fire(o,Events.BLOCK_CHANGE)});const n=document.getElementById("soundList");n&&spriteManager.activeSprite&&spriteManager.activeSprite.sounds&&(n.innerHTML="",Object.entries(spriteManager.activeSprite.sounds).forEach(([o,r])=>{const i=document.createElement("div");i.className="sound-item";const s=document.createElement("span");s.textContent=o,s.className="sound-name",s.addEventListener("dblclick",()=>{const a=prompt(`Rename sound "${o}":`,o);if(a&&a.trim()&&a.trim()!==o){if(spriteManager.activeSprite.sounds[a.trim()]){alert(`A sound named "${a.trim()}" already exists for this sprite. Please choose a different name.`);return}const d=o,c=spriteManager.activeSprite.sounds[d];delete spriteManager.activeSprite.sounds[d],spriteManager.activeSprite.sounds[a.trim()]=c,renderAssetPanels(),window.refreshAllDropdowns()}});const l=document.createElement("button");l.textContent="▶",l.className="sound-play-btn",l.addEventListener("click",()=>{spriteManager.activeSprite.playSound(o)}),i.appendChild(s),i.appendChild(l),n.appendChild(i)}))};window.updateInspector=function(){if(!spriteManager.activeSprite)return;const t=spriteManager.activeSprite,n=document.getElementById("prop-x"),o=document.getElementById("prop-y"),r=document.getElementById("prop-direction"),i=document.getElementById("prop-layer"),s=document.getElementById("prop-size"),l=document.getElementById("prop-flipx"),a=document.getElementById("prop-flipy"),d=document.getElementById("prop-visible"),c=document.getElementById("deleteSpriteBtn");if(n&&(n.value=Math.round(t.x)),o&&(o.value=Math.round(t.y)),r&&(r.value=Math.round(t.direction)),i&&(i.value=t.layer),s&&(s.value=Math.round(t.size)),l&&(l.checked=t.flipX),a&&(a.checked=t.flipY),d&&(d.checked=t.visible),c){const g=spriteManager.sprites.length;c.disabled=g<=1,c.title=g<=1?"Cannot delete the last sprite":"Delete this sprite"}const u=document.getElementById("prop-costume");u&&(u.innerHTML="",t.costumes.forEach((g,m)=>{const f=document.createElement("option");f.value=m,f.textContent=g.name||`Costume ${m+1}`,f.selected=m===t.currentCostumeIndex,u.appendChild(f)}));const p=document.getElementById("components-container");p&&(p.innerHTML="",t.components.forEach(g=>{const m=document.createElement("div");m.className="inspector-section",m.innerHTML=`
        <div class="section-header">
          <h4>${g.name}</h4>
          <button class="btn-remove" onclick="removeComponent('${g.name}')" title="Remove Component">×</button>
        </div>
        <div class="section-content">
          ${g.createInspectorUI()}
        </div>
      `,p.appendChild(m)}))};window.deleteCurrentSprite=function(){if(!spriteManager.activeSprite)return;if(spriteManager.sprites.length<=1){alert("Cannot delete the last sprite in the project!");return}const n=spriteManager.activeSprite,o=n.costumes[n.currentCostumeIndex]?.name||`Sprite ${n.id}`;confirm(`Are you sure you want to delete "${o}"? This action cannot be undone.`)&&(n.delete(),spriteManager.sprites.length>0?spriteManager.activeSprite=spriteManager.sprites[0]:spriteManager.activeSprite=null,renderSpriteList(),renderAssetPanels(),updateInspector(),window.refreshAllDropdowns(),console.log(`Deleted sprite: ${o}`))};window.renameCurrentSprite=function(){if(!spriteManager.activeSprite)return;const t=spriteManager.activeSprite,n=t.costumes[t.currentCostumeIndex]?.name||`Sprite ${t.id}`,o=prompt(`Rename sprite "${n}":`,n);if(!o||!o.trim())return;const r=o.trim();if(spriteManager.sprites.findIndex((s,l)=>l!==spriteManager.sprites.indexOf(t)&&s.costumes[s.currentCostumeIndex]?.name.toLowerCase()===r.toLowerCase())!==-1){alert(`A sprite named "${r}" already exists. Please choose a different name.`);return}t.costumes[t.currentCostumeIndex].name=r,renderSpriteList(),renderAssetPanels(),updateInspector(),window.refreshAllDropdowns(),console.log(`Renamed sprite to: ${r}`)};window.updateSpriteProperty=function(t,n){if(!spriteManager.activeSprite)return;const o=spriteManager.activeSprite;switch(t){case"x":o.goTo(Number(n),o.y);break;case"y":o.goTo(o.x,Number(n));break;case"direction":o.pointInDirection(Number(n));break;case"layer":o.set_layer_to(Number(n));break;case"big":o.setSize(Number(n));break;case"flipx":o.setFlipX(n);break;case"flipy":o.setFlipY(n);break;case"visible":o.visible=n,o.update();break;case"costume":o.setCostume(Number(n)),typeof window.renderAssetPanels=="function"&&window.renderAssetPanels();break}};window.togglePropertiesPanel=function(){const t=document.getElementById("propertiles-panel");t&&(t.classList.toggle("is-hidden"),t.classList.contains("is-hidden")?t.style.display="none":t.style.display="flex")};window.openTab=function(t,n){const o=document.getElementsByClassName("tab-content");for(let s=0;s<o.length;s++)o[s].classList.remove("active");const r=document.getElementsByClassName("tab");for(let s=0;s<r.length;s++)r[s].classList.remove("active");const i=document.getElementById(n);i&&i.classList.add("active"),t&&t.currentTarget&&t.currentTarget.classList.add("active")};window._keys={};document.addEventListener("keydown",t=>{if(console.log(`[KEY DEBUG] Key down: ${t.key}, target: ${t.target.tagName}, code: ${t.code}`),(t.key===" "||t.code==="Space")&&window.isRunning&&t.target.tagName==="BUTTON"){console.log("[KEY DEBUG] Preventing space from triggering button click during game"),t.preventDefault(),t.stopPropagation();return}(t.key===" "||t.code==="Space")&&(console.log("[KEY DEBUG] SPACE key pressed - checking for potential flag event triggers"),console.log(`[KEY DEBUG] window.isRunning: ${window.isRunning}`),console.log("[KEY DEBUG] Active element:",document.activeElement)),window._keys[t.key]=!0,console.log("Key down:",t.key,"Keys now:",window._keys)});document.addEventListener("keyup",t=>{console.log(`[KEY DEBUG] Key up: ${t.key}`),window._keys[t.key]=!1,console.log("Key up:",t.key,"Keys now:",window._keys)});window.getJoystickValue=function(t){return 0};if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",()=>{initThree(),window.addEventListener("resize",onWindowResize),stageCanvas&&(stageCanvas.addEventListener("click",onCanvasClick),stageCanvas.addEventListener("mousedown",onCanvasMouseDown),stageCanvas.addEventListener("mousemove",onCanvasMouseMove),stageCanvas.addEventListener("mouseup",onCanvasMouseUp),stageCanvas.addEventListener("mouseleave",onCanvasMouseUp));const t=document.getElementById("imageUpload");t&&t.addEventListener("change",r=>{const i=r.target&&r.target.files&&r.target.files[0]||null;if(!i)return;const s=new FileReader;s.onload=l=>{const a=l.target?.result;window?.spriteManager&&typeof window.spriteManager.addSprite=="function"&&a&&(window.spriteManager.addSprite(a),renderSpriteList(),renderAssetPanels(),t.value="")},s.readAsDataURL(i)});const n=document.getElementById("costumeUpload");n&&n.addEventListener("change",r=>{const i=r.target&&r.target.files&&r.target.files[0]||null;if(!i||!spriteManager.activeSprite)return;const s=new FileReader;s.onload=l=>{const a=l.target?.result;if(a){const d=`costume${spriteManager.activeSprite.costumes.length+1}`;let c=prompt("Enter costume name:",d);if(!c||!c.trim()){alert("Costume name cannot be empty.");return}if(c=c.trim(),spriteManager.activeSprite.costumes.findIndex(p=>p.name.toLowerCase()===c.toLowerCase())!==-1){alert(`A costume named "${c}" already exists for this sprite. Please choose a different name.`);return}spriteManager.activeSprite.addCostume(c,a),renderAssetPanels(),n.value="",window.refreshAllDropdowns()}},s.readAsDataURL(i)});const o=document.getElementById("soundUpload");o&&o.addEventListener("change",r=>{const i=r.target&&r.target.files&&r.target.files[0]||null;if(!i||!spriteManager.activeSprite)return;const s=new FileReader;s.onload=l=>{const a=l.target?.result;if(a){const d=`sound${Object.keys(spriteManager.activeSprite.sounds).length+1}`;let c=prompt("Enter sound name:",d);if(!c||!c.trim()){alert("Sound name cannot be empty.");return}if(c=c.trim(),spriteManager.activeSprite.sounds[c]){alert(`A sound named "${c}" already exists for this sprite. Please choose a different name.`);return}spriteManager.activeSprite.addSound(c,a),renderAssetPanels(),o.value="",window.refreshAllDropdowns()}},s.readAsDataURL(i)})});else{initThree(),window.addEventListener("resize",onWindowResize),stageCanvas&&(stageCanvas.addEventListener("click",onCanvasClick),stageCanvas.addEventListener("mousedown",onCanvasMouseDown),stageCanvas.addEventListener("mousemove",onCanvasMouseMove),stageCanvas.addEventListener("mouseup",onCanvasMouseUp),stageCanvas.addEventListener("mouseleave",onCanvasMouseUp));const t=document.getElementById("imageUpload");t&&t.addEventListener("change",r=>{const i=r.target&&r.target.files&&r.target.files[0]||null;if(!i)return;const s=new FileReader;s.onload=l=>{const a=l.target?.result;window?.spriteManager&&typeof window.spriteManager.addSprite=="function"&&a&&(window.spriteManager.addSprite(a),renderSpriteList(),renderAssetPanels(),t.value="")},s.readAsDataURL(i)});const n=document.getElementById("costumeUpload");n&&n.addEventListener("change",r=>{const i=r.target&&r.target.files&&r.target.files[0]||null;if(!i||!spriteManager.activeSprite)return;const s=new FileReader;s.onload=l=>{const a=l.target?.result;if(a){const d=`costume${spriteManager.activeSprite.costumes.length+1}`;let c=prompt("Enter costume name:",d);if(!c||!c.trim()){alert("Costume name cannot be empty.");return}if(c=c.trim(),spriteManager.activeSprite.costumes.findIndex(p=>p.name.toLowerCase()===c.toLowerCase())!==-1){alert(`A costume named "${c}" already exists for this sprite. Please choose a different name.`);return}spriteManager.activeSprite.addCostume(c,a),renderAssetPanels(),n.value="",window.refreshAllDropdowns()}},s.readAsDataURL(i)});const o=document.getElementById("soundUpload");o&&o.addEventListener("change",r=>{const i=r.target&&r.target.files&&r.target.files[0]||null;if(!i||!spriteManager.activeSprite)return;const s=new FileReader;s.onload=l=>{const a=l.target?.result;if(a){const d=`sound${Object.keys(spriteManager.activeSprite.sounds).length+1}`;let c=prompt("Enter sound name:",d);if(!c||!c.trim()){alert("Sound name cannot be empty.");return}if(c=c.trim(),spriteManager.activeSprite.sounds[c]){alert(`A sound named "${c}" already exists for this sprite. Please choose a different name.`);return}spriteManager.activeSprite.addSound(c,a),renderAssetPanels(),o.value="",window.refreshAllDropdowns()}},s.readAsDataURL(i)})}window.showAddComponentMenu=function(){const t=document.getElementById("add-component-menu");t&&(t.style.display="block")};window.hideAddComponentMenu=function(){const t=document.getElementById("add-component-menu");t&&(t.style.display="none")};window.addComponent=function(t){if(!spriteManager.activeSprite)return;spriteManager.activeSprite.addComponent(t)?(console.log(`Added ${t} component to sprite`),updateInspector(),hideAddComponentMenu()):console.error(`Failed to add ${t} component`)};window.removeComponent=function(t){if(!spriteManager.activeSprite)return;spriteManager.activeSprite.removeComponent(t)?(console.log(`Removed ${t} component from sprite`),updateInspector()):console.error(`Failed to remove ${t} component`)};window.updateComponentProperty=function(t,n,o){if(!spriteManager.activeSprite)return;const r=spriteManager.activeSprite.getComponent(t);r&&(r.setProperty(n,o),console.log(`Updated ${n} of ${t} to ${o}`))};window.setGlobalLightIntensity=function(t){window.globalAmbientLight&&(window.globalAmbientLight.intensity=Number(t),console.log(`Set global light intensity to ${t}`))};window.setGlobalLightColor=function(t){window.globalAmbientLight&&(window.globalAmbientLight.color.setHex(t),console.log(`Set global light color to ${t}`))};window.getGlobalLightIntensity=function(){return window.globalAmbientLight?window.globalAmbientLight.intensity:.5};window.getGlobalLightColor=function(){return window.globalAmbientLight?window.globalAmbientLight.color.getHex():16777215};document.addEventListener("click",function(t){const n=document.getElementById("add-component-menu"),o=document.querySelector(".btn-add-component");n&&n.style.display==="block"&&!n.contains(t.target)&&!o.contains(t.target)&&hideAddComponentMenu()});window.showVariableCreationDialog=function(){const t=document.createElement("div");t.style.cssText=`
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
  `;const n=document.createElement("div");n.style.cssText=`
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    min-width: 300px;
    font-family: Inter, sans-serif;
  `,n.innerHTML=`
    <h3 style="margin: 0 0 15px 0; color: #333;">New Variable</h3>
    <div style="margin-bottom: 15px;">
      <label style="display: block; margin-bottom: 5px; color: #666;">Variable name:</label>
      <input type="text" id="variableNameInput" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="Enter variable name">
    </div>
    <div style="margin-bottom: 15px;">
      <label style="display: block; margin-bottom: 5px; color: #666;">Scope:</label>
      <select id="variableScopeInput" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        <option value="global">For all sprites</option>
        <option value="sprite">For this sprite only</option>
      </select>
    </div>
    <div style="display: flex; gap: 10px; justify-content: flex-end;">
      <button id="cancelVariableBtn" style="padding: 8px 16px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;">Cancel</button>
      <button id="createVariableBtn" style="padding: 8px 16px; border: none; background: #FF8C1A; color: white; border-radius: 4px; cursor: pointer;">Create</button>
    </div>
  `,t.appendChild(n),document.body.appendChild(t);const o=document.getElementById("variableNameInput"),r=document.getElementById("variableScopeInput"),i=document.getElementById("createVariableBtn"),s=document.getElementById("cancelVariableBtn");o.focus(),o.select();function l(){document.body.removeChild(t)}s.onclick=l,i.onclick=function(){const a=o.value.trim(),d=r.value;if(!a){alert("Please enter a variable name");return}let c=null;if(d==="sprite"){const p=window.spriteManager?.activeSprite;if(!p){alert("Please select a sprite first for sprite-local variables");return}c=p.id}window.variableManager.createVariable(a,d,"number",c)?(console.log(`Created ${d} variable: ${a}`),l(),window.refreshAllDropdowns()):alert(`A variable named "${a}" already exists in this scope`)},o.onkeypress=function(a){a.key==="Enter"?i.click():a.key==="Escape"&&l()},t.onclick=function(a){a.target===t&&l()}};window.showListCreationDialog=function(){const t=document.createElement("div");t.style.cssText=`
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
  `;const n=document.createElement("div");n.style.cssText=`
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    min-width: 300px;
    font-family: Inter, sans-serif;
  `,n.innerHTML=`
    <h3 style="margin: 0 0 15px 0; color: #333;">New List</h3>
    <div style="margin-bottom: 15px;">
      <label style="display: block; margin-bottom: 5px; color: #666;">List name:</label>
      <input type="text" id="listNameInput" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="Enter list name">
    </div>
    <div style="margin-bottom: 15px;">
      <label style="display: block; margin-bottom: 5px; color: #666;">Scope:</label>
      <select id="listScopeInput" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        <option value="global">For all sprites</option>
        <option value="sprite">For this sprite only</option>
      </select>
    </div>
    <div style="display: flex; gap: 10px; justify-content: flex-end;">
      <button id="cancelListBtn" style="padding: 8px 16px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;">Cancel</button>
      <button id="createListBtn" style="padding: 8px 16px; border: none; background: #FF6680; color: white; border-radius: 4px; cursor: pointer;">Create</button>
    </div>
  `,t.appendChild(n),document.body.appendChild(t);const o=document.getElementById("listNameInput"),r=document.getElementById("listScopeInput"),i=document.getElementById("createListBtn"),s=document.getElementById("cancelListBtn");o.focus(),o.select();function l(){document.body.removeChild(t)}s.onclick=l,i.onclick=function(){const a=o.value.trim(),d=r.value;if(!a){alert("Please enter a list name");return}let c=null;if(d==="sprite"){const p=window.spriteManager?.activeSprite;if(!p){alert("Please select a sprite first for sprite-local lists");return}c=p.id}window.listManager.createList(a,d,c)?(console.log(`Created ${d} list: ${a}`),l(),window.refreshAllDropdowns()):alert(`A list named "${a}" already exists in this scope`)},o.onkeypress=function(a){a.key==="Enter"?i.click():a.key==="Escape"&&l()},t.onclick=function(a){a.target===t&&l()}};window.saveProject=function(){const t=prompt("Enter project name:","my-waddle-project");t&&t.trim()&&window.projectManager.saveProject(t.trim())};window.loadProject=function(){const t=document.createElement("input");t.type="file",t.accept=".waddle",t.onchange=async function(n){const o=n.target.files[0];o&&await window.projectManager.loadProject(o)&&console.log("Project loaded successfully!")},t.click()};document.addEventListener("keydown",function(t){(t.ctrlKey||t.metaKey)&&t.key==="s"?(t.preventDefault(),window.saveProject()):(t.ctrlKey||t.metaKey)&&t.key==="o"&&(t.preventDefault(),window.loadProject())});window.saveCurrentWorkspace=function(){if(window.spriteManager?.activeSprite&&window.workspace)try{const t=serialization.workspaces.save(window.workspace);window.spriteManager.activeSprite.workspaceData=JSON.stringify(t)}catch(t){console.warn("Could not save workspace data:",t)}};window.loadWorkspaceData=function(t){if(window.workspace)try{serialization.workspaces.load(t,window.workspace)}catch(n){console.warn("Could not load workspace data:",n),window.workspace.clear()}};window.createSpriteFromData=function(t){try{if(!t.costumes||t.costumes.length===0)return console.warn("Sprite has no costumes, skipping:",t.name),null;const n=t.costumes[0].url;if(console.log(`Loading sprite: ${t.name} with URL:`,n.substring(0,100)+(n.length>100?"...":"")),console.log("URL type:",n.startsWith("data:")?"Data URL":"Regular URL"),!window.blockyinjected){window.injectBlockly();const r=document.querySelector(".propertiles-panel");r&&r.classList.remove("is-hidden")}const o=new Sprite(t.id,n);return o.x=t.x||0,o.y=t.y||0,o.direction=t.direction||90,o.size=t.size||100,o.visible=t.visible!==!1,o.currentCostumeIndex=t.currentCostumeIndex||0,o.effects=t.effects||{},o.flipX=t.flipX||!1,o.flipY=t.flipY||!1,o.layer=t.layer||1,o.volume=t.volume||100,o.workspaceData=t.workspaceData||"",o.costumes=t.costumes,o.costumes[o.currentCostumeIndex]&&(o.costumes[o.currentCostumeIndex].name=t.name),o.sounds=t.sounds||{},window.spriteManager.sprites.push(o),o.update(),window.spriteManager.updateRenderOrder(),window.updateInspector(),typeof window.renderAssetPanels=="function"&&window.renderAssetPanels(),console.log(`Loaded sprite: ${t.name}`),o}catch(n){return console.error("Error loading sprite:",t.name,n),null}};window.reinitializeLights=function(){console.log("Re-initializing scene lights...");const t=window.savedLighting?.ambientIntensity||.8,n=window.savedLighting?.directionalIntensity||.5;if(console.log(`Using light intensities - Ambient: ${t}, Directional: ${n}`),window.globalAmbientLight)window.globalAmbientLight.intensity=t,console.log("Updated ambient light intensity to:",t);else{const r=new AmbientLight(16777215,t);window.threeScene.add(r),window.globalAmbientLight=r,console.log("Added ambient light with intensity:",t)}const o=new DirectionalLight(16777215,n);o.position.set(0,0,10),window.threeScene.add(o),window.globalDirectionalLight=o,console.log("Added directional light with intensity:",n)};
